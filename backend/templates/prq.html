<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual AI Avatar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    </style>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1e21; height: 100vh; overflow: hidden; }
        #avatar-main-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #header { width: 100%; background-color: #fff; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,.1); text-align: center; z-index: 10; }
        h1 { margin: 0; font-size: 1.5rem; color: #4a4a4a; }
        #container { width: 100%; height: 100%; position: relative; }
        #chat-container { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background-color: rgba(255,255,255,.95); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.15); width: 90%; max-width: 600px; align-items: center; z-index: 101; }
        #chat-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; padding: 12px; font-size: 1rem; }
        .chat-btn { padding: 12px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color .3s ease, transform .1s ease; }
        #ask-btn { background-color: #007bff; color: #fff; padding-left: 20px; padding-right: 20px; }
        #mic-btn { background-color: #28a745; }
        #stop-btn { background-color: #dc3545; }
        #visual-output-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .math-container{display:flex;flex-direction:row;gap:2vw;align-items:center;position:absolute;top:5vh;left:50%;transform:translateX(-50%)}
        .math-element{font-size:clamp(3rem,10vw,7rem);font-weight:700;color:#333;text-shadow:2px 2px 5px rgba(0,0,0,.2);opacity:0;transform:translateY(50px) scale(.5);transition:all .5s cubic-bezier(.34,1.56,.64,1)}
        .math-element.visible{opacity:1;transform:translateY(0) scale(1)}
        .comparison-image-container{position:absolute;top:50%;transform:translateY(-50%) scale(.5);opacity:0;transition:all .6s cubic-bezier(.16,1,.3,1)}
        .comparison-image-container.left{left:10vw}
        .comparison-image-container.right{right:10vw}
        .comparison-image-container.visible{transform:translateY(-50%) scale(1);opacity:1}
        .comparison-image-container img{width:clamp(150px,18vw,250px);height:clamp(150px,18vw,250px);border-radius:15px;object-fit:cover;border:5px solid #fff;box-shadow:0 10px 20px rgba(0,0,0,.2)}
        #captured-photo-container { position: absolute; left: 40px; bottom: 120px; width: 220px; height: 220px; padding: 10px; background-color: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transform: translateY(100%); transition: all .6s cubic-bezier(.16,1,.3,1); }
        #captured-photo-container.visible { opacity: 1; transform: translateY(0); }
        #captured-photo-container img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
        .image-topic-container{position:absolute;left:40px;bottom:120px;display:flex;align-items:center;gap:20px;opacity:0;transform:translateY(100%);transition:all .6s cubic-bezier(.16,1,.3,1)}
        .image-topic-container.visible{opacity:1;transform:translateY(0)}
        .image-topic-container img{width:220px;height:220px;padding:10px;background-color:white;border-radius:15px;object-fit:cover;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
        #top-text-container{position:absolute;top:3vh;left:50%;transform:translateX(-50%);width:90%;max-width:900px;text-align:center;font-size:1.8rem;font-weight:600;color:#333}
        .caption-word{display:inline-block;opacity:0;transform:translateY(10px);transition:opacity .4s ease,transform .4s ease;margin-right:.4rem}
        .caption-word.visible{opacity:1;transform:translateY(0)}
        #timer-widget { pointer-events: auto; position: absolute; top: 3vh; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; width: 300px; }
        #timer-display { font-size: 3.5rem; font-weight: 700; color: #333; font-family: 'Inter', sans-serif, monospace; }
        #timer-controls { display: flex; gap: 0.5rem; }
        .timer-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .timer-btn.start { background-color: #28a745; }
        .timer-btn.pause { background-color: #ffc107; }
        .timer-btn.reset { background-color: #dc3545; }
        .timer-btn.edit { background-color: #6c757d; }
        #camera-modal-overlay { font-family: 'Inter', sans-serif; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        #camera-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .camera-container { max-width: 600px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; position: relative; background-color: #1e293b; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: translateY(100vh); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #camera-modal-overlay.visible .camera-container { transform: translateY(0); }
        #editing-view { overflow-y: auto; }
        @keyframes flash-effect { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .flash { animation: flash-effect 0.5s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: #1e293b; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div id="avatar-main-container">
        <div id="header"><h1>Visual AI Avatar</h1></div>
        <div id="container">
            <div id="visual-output-container"></div>
            <div id="chat-container">
                <input type="text" id="chat-input" placeholder="Type or use the mic..."><button id="ask-btn" class="chat-btn">‚ú® Ask</button><button id="mic-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button><button id="stop-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M6 6h12v12H6z"/></svg></button>
            </div>
        </div>
    </div>
    <audio id="timer-alarm" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
    
    <div id="camera-modal-overlay" class="hidden">
        <div class="camera-container">
            <button id="close-camera-btn" class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-full text-sm z-10">Close</button>
            <h1 class="text-3xl font-bold mb-6 text-center text-indigo-400 shrink-0">AI Avatar Camera</h1>
            <div id="camera-view" class="w-full h-auto flex flex-col items-center">
                <video id="video-feed" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6" autoplay playsinline></video>
                <div id="timer-display" class="text-5xl font-extrabold text-white mb-6 hidden"></div>
                <button id="take-photo-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-full">Take a Photo</button>
            </div>
            <div id="editing-view" class="w-full h-auto hidden flex-col items-center">
                <canvas id="main-canvas" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6 cursor-grab"></canvas>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Filters</h2>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-filter="none" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">None</button>
                        <button data-filter="grayscale" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Grayscale</button>
                        <button data-filter="sepia" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Sepia</button>
                        <button data-filter="invert" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Invert</button>
                        <button data-filter="saturate" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Saturate</button>
                        <button data-filter="contrast" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Contrast</button>
                        <button data-filter="brightness" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Bright</button>
                        <button data-filter="blur" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Blur</button>
                    </div>
                </div>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Emojis</h2>
                    <div class="flex justify-center flex-wrap gap-4 text-4xl">
                        <span class="emoji-button" data-emoji="üòé">üòé</span><span class="emoji-button" data-emoji="üòÇ">üòÇ</span><span class="emoji-button" data-emoji="ü§©">ü§©</span><span class="emoji-button" data-emoji="ü•≥">ü•≥</span><span class="emoji-button" data-emoji="ü§Ø">ü§Ø</span><span class="emoji-button" data-emoji="üòç">üòç</span><span class="emoji-button" data-emoji="üëç">üëç</span><span class="emoji-button" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
                    </div>
                </div>
                <div id="size-control-container" class="w-full mb-6 hidden">
                    <label for="size-slider" class="text-lg font-bold mb-2 block text-center text-slate-300">Adjust Size</label>
                    <input id="size-slider" type="range" min="20" max="300" value="96" class="w-3/4 mx-auto block">
                </div>
                <div id="photo-actions" class="mt-4 space-x-4 shrink-0">
                    <button id="save-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save Photo</button>
                    <button id="retake-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Retake</button>
                </div>
            </div>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div id="flash-overlay" class="absolute inset-0 bg-white rounded-xl hidden"></div>
        </div>
        <div id="save-modal" class="modal-overlay hidden">
            <div class="modal-content text-center">
                <h2 class="text-xl font-bold mb-4">What's your name?</h2>
                <input type="text" id="filename-input" class="w-full rounded-md px-4 py-2 mb-4 bg-slate-700 border border-slate-600 text-white" placeholder="e.g., Alex">
                <div class="flex justify-center space-x-4">
                    <button id="modal-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save</button>
                    <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 1. AI AVATAR LOGIC ---
        // IMPORTANT: The keys below are non-working examples. 
        // You MUST replace them with your own keys for the image search to work for all topics.
        const GOOGLE_API_KEY = 'AIzaSyAvqtVK1lvKclk9RpU9-qKufHVGfWsg_gw';
        const GOOGLE_CX_ID = '83c4d23e4411a429b';
        
        const scene=new THREE.Scene();scene.background=new THREE.Color(0xf0f2f5);const camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,1000);camera.position.set(0,1.5,5);const renderer=new THREE.WebGLRenderer({antialias:!0});
        document.getElementById('container').appendChild(renderer.domElement);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled=!0;const ambientLight=new THREE.AmbientLight(0xffffff,0.8);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(0xffffff,1);directionalLight.position.set(5,10,7.5);directionalLight.castShadow=!0;scene.add(directionalLight);const ground=new THREE.Mesh(new THREE.PlaneGeometry(10,10),new THREE.MeshStandardMaterial({color:0xcccccc}));ground.rotation.x=-Math.PI/2;ground.receiveShadow=!0;scene.add(ground);const controls=new OrbitControls(camera,renderer.domElement);controls.target.set(0,1,0);controls.update();let mixer,character;const animations=new Map();const clock=new THREE.Clock();const gltfLoader=new GLTFLoader();const chatInput=document.getElementById('chat-input');const askButton=document.getElementById('ask-btn');const micButton=document.getElementById('mic-btn');const stopButton=document.getElementById('stop-btn');const CHARACTER_MODEL_PATH='/static/character.glb';const IDLE_ANIM_NAME='idle',TALKING_ANIM_NAME='talk';gltfLoader.load(CHARACTER_MODEL_PATH,(gltf)=>{character=gltf.scene;scene.add(character);mixer=new THREE.AnimationMixer(character);gltf.animations.forEach((clip)=>{const clipName=clip.name.toLowerCase()==='jum'?'jump':clip.name.toLowerCase();animations.set(clipName,mixer.clipAction(clip))});if(animations.has(IDLE_ANIM_NAME))playAnimation(IDLE_ANIM_NAME)});let currentAnimation=null;let animationTimeout;
        function playAnimation(name,duration=null){const t=name.toLowerCase();if(!animations.has(t))return;clearTimeout(animationTimeout);const e=["idle","talk"].includes(t)||duration,o=animations.get(t);o.timeScale="dance"===t||"jump"===t||"walk"===t?.5:1;const i=currentAnimation?animations.get(currentAnimation):null;i&&i.fadeOut(.3),o.reset().setEffectiveWeight(1).fadeIn(.3).play(),o.loop=e?THREE.LoopRepeat:THREE.LoopOnce,o.clampWhenFinished=!e,currentAnimation=t,duration?animationTimeout=setTimeout(()=>{playAnimation("idle")},duration):e||mixer.addEventListener("finished",function t(){playAnimation("idle"),mixer.removeEventListener("finished",t)})}
        const visualOutputContainer=document.getElementById("visual-output-container");
        async function renderVisualOutput(data){clearVisuals();switch(data.type){case"set_timer":createTimerWidget(data.seconds);break;case"open_camera":try{const t=await openCameraModal();displayCapturedPhoto(t.imageDataUrl),speakText(`Hey ${t.filename}, this is your image.`,!0),triggerAutoDownload(t.imageDataUrl,t.filename)}catch(t){speakText("Okay, maybe next time.",!0)}break;case"animation_command":playAnimation(data.animation_name,5e3);break;case"sing_song":createTopTextContainer();break;case"math_sequence":renderMathSequence(data.elements);break;case"image_topic":renderImage(await fetchGoogleImage(data.search_term));break;case"comparison_topic":createTopTextContainer(),renderComparisonImages(data.entities);break;case"simple_text":default:createTopTextContainer()}}
        function createTopTextContainer(){const t=document.createElement("div");t.id="top-text-container",visualOutputContainer.appendChild(t)}async function renderComparisonImages(t){const e=t.map(t=>fetchGoogleImage(t.search_term)),n=await Promise.all(e),o=document.createElement("div");o.className="comparison-image-container left";const i=document.createElement("img");i.src=n[0],o.appendChild(i),visualOutputContainer.appendChild(o),n.length>1&&(()=>{const t=document.createElement("div");t.className="comparison-image-container right";const e=document.createElement("img");e.src=n[1],t.appendChild(e),visualOutputContainer.appendChild(t)})(),setTimeout(()=>{o.classList.add("visible"),visualOutputContainer.querySelector(".right")?.classList.add("visible")},50)}async function renderMathSequence(t){const e=document.createElement("div");e.className="math-container",visualOutputContainer.appendChild(e);for(const n of t){const t=document.createElement("span");t.className="math-element",t.textContent=n,e.appendChild(t),await new Promise(t=>setTimeout(t,50)),t.classList.add("visible"),await new Promise(t=>setTimeout(t,600))}}
        
        function renderImage(imageUrl) {
            const container = document.createElement("div");
            container.className = "image-topic-container";
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            container.appendChild(imgElement);
            visualOutputContainer.appendChild(container);
            setTimeout(() => container.classList.add("visible"), 100);
            createTopTextContainer();
        }

        function showLoadingIndicator(){clearVisuals(),createTopTextContainer(),document.getElementById("top-text-container").textContent="Thinking... ü§î"}function clearVisuals(){visualOutputContainer.innerHTML=""}
        
        // UPDATED: fetchGoogleImage now generates more varied placeholders or uses the real API if keys are set
        async function fetchGoogleImage(searchTerm){
            const defaultPlaceholder = "https://picsum.photos/220/220?grayscale";

            // If API keys are placeholders, use the improved simulation logic
            if (GOOGLE_API_KEY.includes("PASTE_") || GOOGLE_CX_ID.includes("PASTE_")) {
                console.warn("‚ö†Ô∏è Google API keys not configured. Using placeholder simulation.");
                const lowerSearchTerm = searchTerm.toLowerCase();
                let category = lowerSearchTerm; // Default to the search term itself

                // Categorize the search term to get a better placeholder
                if (lowerSearchTerm.includes("lion") || lowerSearchTerm.includes("tiger") || lowerSearchTerm.includes("dog") || lowerSearchTerm.includes("cat") || lowerSearchTerm.includes("animal")) {
                    category = "animal " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("dinosaur") || lowerSearchTerm.includes("creature")) {
                    category = "dinosaur art " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("flower") || lowerSearchTerm.includes("rose") || lowerSearchTerm.includes("plant") || lowerSearchTerm.includes("tree")) {
                    category = "nature " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("fruit") || lowerSearchTerm.includes("apple") || lowerSearchTerm.includes("banana")) {
                    category = "fruit " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("person") || lowerSearchTerm.includes("famous") || lowerSearchTerm.includes("actor") || lowerSearchTerm.includes("scientist")) {
                    category = "portrait " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("fire") || lowerSearchTerm.includes("water") || lowerSearchTerm.includes("sand") || lowerSearchTerm.includes("element")) {
                    category = "nature element " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("galaxy") || lowerSearchTerm.includes("universe") || lowerSearchTerm.includes("planet") || lowerSearchTerm.includes("star")) {
                    category = "space " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("cartoon") || lowerSearchTerm.includes("movie character") || lowerSearchTerm.includes("superhero")) {
                    category = "character art " + lowerSearchTerm;
                } else if (lowerSearchTerm.includes("car") || lowerSearchTerm.includes("house") || lowerSearchTerm.includes("non living")) {
                    category = "object " + lowerSearchTerm;
                }
                
                // Use Unsplash Source to get a random image based on the category
                return `https://source.unsplash.com/220x220/?${encodeURIComponent(category)}`;
            }

            // If real API keys are present, use the Google Custom Search API
            const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX_ID}&q=${encodeURIComponent(searchTerm)}&searchType=image&num=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Google API error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    return data.items[0].link;
                } else {
                    console.warn("‚ö†Ô∏è No image found from Google for:", searchTerm);
                    return defaultPlaceholder;
                }
            } catch (error) {
                console.error("üî¥ Error fetching image from Google API:", error);
                return defaultPlaceholder;
            }
        }

        async function processInput(t){askButton.disabled=!0,micButton.disabled=!0,showLoadingIndicator(),chatInput.value="",await callBackendAPI(t)}
        async function callBackendAPI(t){try{const e=await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();await renderVisualOutput(n),n.spoken_text&&"open_camera"!==n.type&&speakText(n.spoken_text,"animation_command"!==n.type)}catch(t){const e={spoken_text:"Oh no, my brain circuits are tangled!"};createTopTextContainer(),speakText(e.spoken_text,!0)}}
        function speakText(t,e){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(t),o=document.getElementById("top-text-container");if(o&&e){o.innerHTML="";const i=t.split(/\s+/),s=[];i.forEach(t=>{const e=document.createElement("span");e.className="caption-word",e.textContent=t,o.appendChild(e),s.push(e)});let l=0;n.onboundary=t=>{"word"===t.name&&l<s.length&&(s[l].classList.add("visible"),l++)}}
        e&&(n.onstart=()=>playAnimation("talk")),n.onend=()=>{if("talk"===currentAnimation&&playAnimation("idle"),askButton.disabled=!1,micButton.disabled=!1,o&&!document.getElementById("timer-widget")){o.querySelectorAll(".caption-word").forEach(t=>t.classList.add("visible"));setTimeout(clearVisuals,4e3)}},speechSynthesis.speak(n)}
        
        // --- 2. TIMER WIDGET LOGIC ---
        let timerInterval,timeRemainingInSeconds,isTimerPaused=!0,initialSeconds=0;
        function createTimerWidget(seconds){initialSeconds=seconds,timeRemainingInSeconds=seconds;if(isNaN(timeRemainingInSeconds)){console.error("Timer started with invalid seconds value:",seconds);timeRemainingInSeconds=0}const t=document.createElement("div");t.id="timer-widget",t.innerHTML=`\n                <div id="timer-display"></div>\n                <div id="timer-controls">\n                    <button id="timer-start-pause" class="timer-btn start">Start</button>\n                    <button id="timer-reset" class="timer-btn reset">Reset</button>\n                    <button id="timer-edit" class="timer-btn edit">Edit</button>\n                </div>\n            `,visualOutputContainer.appendChild(t),updateTimerDisplay(),document.getElementById("timer-start-pause").onclick=toggleTimer,document.getElementById("timer-reset").onclick=resetTimer,document.getElementById("timer-edit").onclick=editTimer}
        function updateTimerDisplay(){const t=document.getElementById("timer-display");if(t){const e=Math.floor(timeRemainingInSeconds/60),n=timeRemainingInSeconds%60;t.textContent=`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}}
        function toggleTimer(){if(isTimerPaused=!isTimerPaused,timeRemainingInSeconds<=0)return;const t=document.getElementById("timer-start-pause");isTimerPaused?(t.textContent="Start",t.className="timer-btn start",clearInterval(timerInterval)):(t.textContent="Pause",t.className="timer-btn pause",timerInterval=setInterval(tick,1e3))}
        function tick(){--timeRemainingInSeconds,updateTimerDisplay(),timeRemainingInSeconds<0&&(timeRemainingInSeconds=0),0===timeRemainingInSeconds&&(clearInterval(timerInterval),document.getElementById("timer-alarm").play(),setTimeout(()=>{clearVisuals(),speakText("Time's up! Your timer has finished.",!0)},4e3))}
        function resetTimer(){clearInterval(timerInterval),isTimerPaused=!0,createTimerWidget(initialSeconds)}
        function editTimer(){clearInterval(timerInterval),isTimerPaused=!0;const t=prompt(`Enter new time (e.g., '5m' for minutes or '30s' for seconds):`,`${Math.floor(initialSeconds/60)}m`);if(t){let e=0;t.toLowerCase().includes("m")?e=60*parseInt(t,10):t.toLowerCase().includes("s")?e=parseInt(t,10):!isNaN(parseInt(t,10))&&(e=60*parseInt(t,10)),e&&!isNaN(e)&&e>0?createTimerWidget(e):createTimerWidget(initialSeconds)}else createTimerWidget(initialSeconds)}
        stopButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearTimeout(animationTimeout),clearInterval(timerInterval),playAnimation("idle"),clearVisuals(),askButton.disabled=!1,micButton.disabled=!1});
        const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(SpeechRecognition){const t=new SpeechRecognition;t.continuous=!1,t.lang="en-US",t.interimResults=!1,micButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearVisuals(),chatInput.value="",t.start()}),t.onstart=()=>micButton.classList.add("listening"),t.onend=()=>micButton.classList.remove("listening"),t.onresult=e=>{const n=e.results[e.results.length-1][0].transcript.trim();chatInput.value=n,processInput(n)}}else micButton.style.display="none";
        askButton.addEventListener("click",()=>{const t=chatInput.value;t&&(speechSynthesis.cancel(),clearVisuals(),processInput(t))}),chatInput.addEventListener("keyup",t=>{t.key==="Enter"&&askButton.click()});function animate(){requestAnimationFrame(animate);const t=clock.getDelta();mixer&&mixer.update(t),renderer.render(scene,camera)}animate();
        window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});

        // --- 3. CAMERA MODAL LOGIC ---
        const cameraModalOverlay = document.getElementById('camera-modal-overlay');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const videoFeed = document.getElementById('video-feed');
        const mainCanvas = document.getElementById('main-canvas');
        const photoCanvas = document.getElementById('photo-canvas');
        const timerDisplay = document.getElementById('timer-display');
        const takePhotoButton = document.getElementById('take-photo-button');
        const saveButton = document.getElementById('save-button');
        const retakeButton = document.getElementById('retake-button');
        const saveModal = document.getElementById('save-modal');
        const filenameInput = document.getElementById('filename-input');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const cameraView = document.getElementById('camera-view');
        const editingView = document.getElementById('editing-view');
        const flashOverlay = document.getElementById('flash-overlay');
        const sizeControlContainer = document.getElementById('size-control-container');
        const sizeSlider = document.getElementById('size-slider');
        let stream, currentFilter="none", capturedImage, ctx=mainCanvas.getContext("2d");
        let selectedObject = null, isDragging = false, dragStart = {x:0, y:0}, objectStart = {x:0, y:0};
        function openCameraModal(){return new Promise((t,e)=>{cameraModalOverlay.classList.remove("hidden"),setTimeout(()=>cameraModalOverlay.classList.add("visible"),10),startCamera();const n=()=>{saveModal.classList.remove("hidden")},o=()=>{let o=filenameInput.value.trim()||"avatar-photo",i=mainCanvas.toDataURL("image/jpeg");s(),r(),t({imageDataUrl:i,filename:o})},i=()=>{saveModal.classList.add("hidden")},s=()=>{cameraModalOverlay.classList.remove("visible"),setTimeout(()=>cameraModalOverlay.classList.add("hidden"),500),stopCamera(),retakeButton.click()},r=()=>{saveButton.removeEventListener("click",n),modalSaveBtn.removeEventListener("click",o),modalCancelBtn.removeEventListener("click",i),closeCameraBtn.removeEventListener("click",a)},a=()=>{s(),r(),e("Camera closed by user")};saveButton.addEventListener("click",n),modalSaveBtn.addEventListener("click",o),modalCancelBtn.addEventListener("click",i),closeCameraBtn.addEventListener("click",a)})}
        function displayCapturedPhoto(imageDataUrl){const t=document.getElementById("captured-photo-container");t&&t.remove();const e=document.createElement("div");e.id="captured-photo-container";const n=document.createElement("img");n.src=imageDataUrl,e.appendChild(n),visualOutputContainer.appendChild(e),setTimeout(()=>e.classList.add("visible"),100)}
        function triggerAutoDownload(t,e){const n=document.createElement("a");n.href=t,n.download=`${e}.jpeg`,n.click()}
        async function startCamera(){try{stream=await navigator.mediaDevices.getUserMedia({video:!0}),videoFeed.srcObject=stream,await videoFeed.play(),cameraView.classList.remove("hidden"),editingView.classList.add("hidden"),editingView.classList.remove("flex"),takePhotoButton.classList.remove("hidden")}catch(t){console.error("Error accessing camera: ",t)}}
        function stopCamera(){stream&&stream.getTracks().forEach(t=>t.stop())}
        function startTimer(){let t=3;timerDisplay.textContent=t,timerDisplay.classList.remove("hidden"),takePhotoButton.classList.add("hidden");const e=setInterval(()=>{t--,timerDisplay.textContent=t,0===t&&(clearInterval(e),timerDisplay.classList.add("hidden"),capturePhoto())},1e3)}
        function capturePhoto(){photoCanvas.width=videoFeed.videoWidth,photoCanvas.height=videoFeed.videoHeight;const t=photoCanvas.getContext("2d");t.drawImage(videoFeed,0,0,photoCanvas.width,photoCanvas.height),capturedImage=new Image,capturedImage.src=photoCanvas.toDataURL("image/jpeg"),capturedImage.onload=()=>{mainCanvas.width=capturedImage.width,mainCanvas.height=capturedImage.height,ctx.drawImage(capturedImage,0,0),cameraView.classList.add("hidden"),editingView.classList.remove("hidden"),editingView.classList.add("flex"),stopCamera(),flashEffect()}}
        function flashEffect(){flashOverlay.style.width=`${mainCanvas.offsetWidth}px`,flashOverlay.style.height=`${mainCanvas.offsetHeight}px`,flashOverlay.style.left=`${mainCanvas.offsetLeft}px`,flashOverlay.style.top=`${mainCanvas.offsetTop}px`,flashOverlay.classList.remove("hidden"),flashOverlay.classList.add("flash"),setTimeout(()=>{flashOverlay.classList.add("hidden"),flashOverlay.classList.remove("flash")},500)}
        function redrawCanvas(){ctx.clearRect(0,0,mainCanvas.width,mainCanvas.height),ctx.filter=currentFilter,ctx.drawImage(capturedImage,0,0,mainCanvas.width,mainCanvas.height),ctx.filter="none";if(selectedObject){const{type:t,value:e,size:n,position:o}=selectedObject;"emoji"===t&&(ctx.font=`${n}px serif`,ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(e,o.x,o.y))}}
        document.querySelectorAll(".filter-button").forEach(t=>{t.addEventListener("click",()=>{switch(t.dataset.filter){case"none":currentFilter="none";break;case"grayscale":currentFilter="grayscale(1)";break;case"sepia":currentFilter="sepia(1)";break;case"invert":currentFilter="invert(1)";break;case"saturate":currentFilter="saturate(200%)";break;case"contrast":currentFilter="contrast(200%)";break;case"brightness":currentFilter="brightness(150%)";break;case"blur":currentFilter="blur(5px)";break}redrawCanvas()})});
        function selectObject(t,e){selectedObject={type:t,value:e,size:parseInt(sizeSlider.value),position:{x:mainCanvas.width/2,y:mainCanvas.height/2}},sizeControlContainer.classList.remove("hidden"),redrawCanvas()}
        document.querySelectorAll(".emoji-button").forEach(t=>t.addEventListener("click",()=>selectObject("emoji",t.dataset.emoji))),sizeSlider.addEventListener("input",t=>{selectedObject&&(selectedObject.size=parseInt(t.target.value),redrawCanvas())});
        mainCanvas.addEventListener('mousedown', e => { if (selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; const { position, size } = selectedObject; if (mouseX > position.x - size / 2 && mouseX < position.x + size / 2 && mouseY > position.y - size / 2 && mouseY < position.y + size / 2) { isDragging = true; mainCanvas.style.cursor = 'grabbing'; dragStart.x = mouseX; dragStart.y = mouseY; objectStart.x = position.x; objectStart.y = position.y; } } });
        mainCanvas.addEventListener('mousemove', e => { if (isDragging && selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; selectedObject.position.x = objectStart.x + (mouseX - dragStart.x); selectedObject.position.y = objectStart.y + (mouseY - dragStart.y); redrawCanvas(); } });
        mainCanvas.addEventListener('mouseup', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        mainCanvas.addEventListener('mouseleave', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        closeCameraBtn.addEventListener('click', ()=>{const e=document.createEvent("Event");e.initEvent("manualclose",!0,!0),closeCameraBtn.dispatchEvent(e)});
        takePhotoButton.addEventListener('click', startTimer);
        retakeButton.addEventListener("click",()=>{currentFilter="none",selectedObject=null,sizeControlContainer.classList.add("hidden"),sizeSlider.value=96,startCamera()});
        saveButton.addEventListener('click',()=>saveModal.classList.remove("hidden"));
        modalCancelBtn.addEventListener('click',()=>saveModal.classList.add("hidden"));
        modalSaveBtn.addEventListener("click",()=>{const t=document.createEvent("Event");t.initEvent("manualsave",!0,!0),modalSaveBtn.dispatchEvent(t)});
    </script>
</body>
</html> -->



















<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual AI Avatar</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
    </style>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1e21; height: 100vh; overflow: hidden; }
        #avatar-main-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #header { width: 100%; background-color: #fff; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,.1); text-align: center; z-index: 10; }
        h1 { margin: 0; font-size: 1.5rem; color: #4a4a4a; }
        #container { width: 100%; height: 100%; position: relative; }
        #chat-container { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background-color: rgba(255,255,255,.95); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.15); width: 90%; max-width: 600px; align-items: center; z-index: 101; }
        #chat-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; padding: 12px; font-size: 1rem; }
        .chat-btn { padding: 12px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color .3s ease, transform .1s ease; }
        #ask-btn { background-color: #007bff; color: #fff; padding-left: 20px; padding-right: 20px; }
        #mic-btn { background-color: #28a745; }
        #stop-btn { background-color: #dc3545; }
        #visual-output-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .math-container{display:flex;flex-direction:row;gap:2vw;align-items:center;position:absolute;top:5vh;left:50%;transform:translateX(-50%)}
        .math-element{font-size:clamp(3rem,10vw,7rem);font-weight:700;color:#333;text-shadow:2px 2px 5px rgba(0,0,0,.2);opacity:0;transform:translateY(50px) scale(.5);transition:all .5s cubic-bezier(.34,1.56,.64,1)}
        .math-element.visible{opacity:1;transform:translateY(0) scale(1)}
        .comparison-image-container{position:absolute;top:50%;transform:translateY(-50%) scale(.5);opacity:0;transition:all .6s cubic-bezier(.16,1,.3,1)}
        .comparison-image-container.left{left:10vw}
        .comparison-image-container.right{right:10vw}
        .comparison-image-container.visible{transform:translateY(-50%) scale(1);opacity:1}
        .comparison-image-container img{width:clamp(150px,18vw,250px);height:clamp(150px,18vw,250px);border-radius:15px;object-fit:cover;border:5px solid #fff;box-shadow:0 10px 20px rgba(0,0,0,.2)}
        #captured-photo-container { position: absolute; left: 40px; bottom: 120px; width: 220px; height: 220px; padding: 10px; background-color: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transform: translateY(100%); transition: all .6s cubic-bezier(.16,1,.3,1); }
        #captured-photo-container.visible { opacity: 1; transform: translateY(0); }
        #captured-photo-container img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
        .image-topic-container{position:absolute;left:40px;bottom:120px;display:flex;align-items:center;gap:20px;opacity:0;transform:translateY(100%);transition:all .6s cubic-bezier(.16,1,.3,1)}
        .image-topic-container.visible{opacity:1;transform:translateY(0)}
        .image-topic-container img{width:220px;height:220px;padding:10px;background-color:white;border-radius:15px;object-fit:cover;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
        #top-text-container{position:absolute;top:3vh;left:50%;transform:translateX(-50%);width:90%;max-width:900px;text-align:center;font-size:1.8rem;font-weight:600;color:#333}
        .caption-word{display:inline-block;opacity:0;transform:translateY(10px);transition:opacity .4s ease,transform .4s ease;margin-right:.4rem}
        .caption-word.visible{opacity:1;transform:translateY(0)}
        #timer-widget { pointer-events: auto; position: absolute; top: 3vh; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; width: 300px; }
        #timer-display { font-size: 3.5rem; font-weight: 700; color: #333; font-family: 'Inter', sans-serif, monospace; }
        #timer-controls { display: flex; gap: 0.5rem; }
        .timer-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .timer-btn.start { background-color: #28a745; }
        .timer-btn.pause { background-color: #ffc107; }
        .timer-btn.reset { background-color: #dc3545; }
        .timer-btn.edit { background-color: #6c757d; }
        #camera-modal-overlay { font-family: 'Inter', sans-serif; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        #camera-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .camera-container { max-width: 600px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; position: relative; background-color: #1e293b; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: translateY(100vh); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #camera-modal-overlay.visible .camera-container { transform: translateY(0); }
        #editing-view { overflow-y: auto; }
        @keyframes flash-effect { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .flash { animation: flash-effect 0.5s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: #1e293b; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        
        /* --- Upgraded Trivia Game Styles --- */
        #trivia-modal-overlay {
            background-color: #0f172a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 20px 20px;
            color: #fff;
            transition: opacity 0.3s ease;
        }
        #trivia-modal-overlay.visible { opacity: 1; }
        #trivia-container {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            width: 100%;
            max-width: 48rem;
            margin: auto;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .topic-btn, #next-question-btn { transition: all 0.3s ease-in-out; border: 1px solid transparent; cursor: pointer; }
        .topic-btn:hover, #next-question-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
            border-color: rgba(59, 130, 246, 0.8);
        }
        .answer-btn { transition: all 0.2s ease-in-out; border: 1px solid #4b5563; }
        .answer-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            border-color: #3b82f6;
            background-color: #374151;
        }
        .correct {
            background-image: linear-gradient(to right, #22c55e, #16a34a) !important;
            border-color: #86efac !important;
            color: white !important;
        }
        .incorrect {
            background-image: linear-gradient(to right, #ef4444, #dc2626) !important;
            border-color: #fca5a5 !important;
            color: white !important;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shakeIncorrect { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-pulseCorrect { animation: pulseCorrect 0.7s ease-in-out; }
        .animate-shakeIncorrect { animation: shakeIncorrect 0.6s ease-in-out; }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="avatar-main-container">
        <div id="header"><h1>Visual AI Avatar</h1></div>
        <div id="container">
            <div id="visual-output-container"></div>
            <div id="chat-container">
                <input type="text" id="chat-input" placeholder="Type or use the mic..."><button id="ask-btn" class="chat-btn">‚ú® Ask</button><button id="mic-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="white"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button><button id="stop-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="white"><path d="M6 6h12v12H6z"/></svg></button>
            </div>
        </div>
    </div>
    <audio id="timer-alarm" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
    
    <div id="camera-modal-overlay" class="hidden">
        <div class="camera-container">
            <button id="close-camera-btn" class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-full text-sm z-10">Close</button>
            <h1 class="text-3xl font-bold mb-6 text-center text-indigo-400 shrink-0">AI Avatar Camera</h1>
            <div id="camera-view" class="w-full h-auto flex flex-col items-center">
                <video id="video-feed" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6" autoplay playsinline></video>
                <div id="camera-timer-display" class="text-5xl font-extrabold text-white mb-6 hidden"></div>
                <button id="take-photo-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-full">Take a Photo</button>
            </div>
            <div id="editing-view" class="w-full h-auto hidden flex-col items-center">
                <canvas id="main-canvas" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6 cursor-grab"></canvas>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Filters</h2>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-filter="none" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">None</button>
                        <button data-filter="grayscale" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Grayscale</button>
                        <button data-filter="sepia" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Sepia</button>
                        <button data-filter="invert" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Invert</button>
                        <button data-filter="saturate" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Saturate</button>
                        <button data-filter="contrast" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Contrast</button>
                        <button data-filter="brightness" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Bright</button>
                        <button data-filter="blur" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Blur</button>
                    </div>
                </div>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Emojis</h2>
                    <div class="flex justify-center flex-wrap gap-4 text-4xl">
                        <span class="emoji-button" data-emoji="üòé">üòé</span><span class="emoji-button" data-emoji="üòÇ">üòÇ</span><span class="emoji-button" data-emoji="ü§©">ü§©</span><span class="emoji-button" data-emoji="ü•≥">ü•≥</span><span class="emoji-button" data-emoji="ü§Ø">ü§Ø</span><span class="emoji-button" data-emoji="üòç">üòç</span><span class="emoji-button" data-emoji="üëç">üëç</span><span class="emoji-button" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
                    </div>
                </div>
                <div id="size-control-container" class="w-full mb-6 hidden">
                    <label for="size-slider" class="text-lg font-bold mb-2 block text-center text-slate-300">Adjust Size</label>
                    <input id="size-slider" type="range" min="20" max="300" value="96" class="w-3/4 mx-auto block">
                </div>
                <div id="photo-actions" class="mt-4 space-x-4 shrink-0">
                    <button id="save-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save Photo</button>
                    <button id="retake-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Retake</button>
                </div>
            </div>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div id="flash-overlay" class="absolute inset-0 bg-white rounded-xl hidden"></div>
        </div>
        <div id="save-modal" class="modal-overlay hidden">
            <div class="modal-content text-center">
                <h2 class="text-xl font-bold mb-4">What's your name?</h2>
                <input type="text" id="filename-input" class="w-full rounded-md px-4 py-2 mb-4 bg-slate-700 border border-slate-600 text-white" placeholder="e.g., Alex">
                <div class="flex justify-center space-x-4">
                    <button id="modal-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save</button>
                    <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="trivia-modal-overlay" class="fixed inset-0 p-4 flex items-center justify-center z-[1000] opacity-0 pointer-events-none hidden">
        <div id="trivia-container" class="relative">
            <div id="topic-selection">
                <button onclick="goHome()" class="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 z-10">üè† Home</button>
                <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-500">AI Student Trivia</h1>
                <p class="text-gray-400 mb-8">For students aged 6-14. Pick a topic to start!</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="startGame('General Knowledge')" class="topic-btn p-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl text-lg md:text-xl font-semibold">üß† General Knowledge</button>
                    <button onclick="startGame('Science Fun')" class="topic-btn p-6 bg-gradient-to-br from-green-500 to-green-600 rounded-xl text-lg md:text-xl font-semibold">üî¨ Science Fun</button>
                    <button onclick="startGame('History & Myths')" class="topic-btn p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl text-lg md:text-xl font-semibold">üìú History & Myths</button>
                    <button onclick="startGame('World Explorer')" class="topic-btn p-6 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl text-lg md:text-xl font-semibold">üåç World Explorer</button>
                    <button onclick="startGame('Math & Logic')" class="topic-btn p-6 bg-gradient-to-br from-red-500 to-red-600 rounded-xl text-lg md:text-xl font-semibold">‚ûï Math & Logic</button>
                    <button onclick="startGame('Aptitude Puzzles')" class="topic-btn p-6 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl text-lg md:text-xl font-semibold">ü§î Aptitude Puzzles</button>
                </div>
            </div>
            <div id="game-view" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-2">
                        <button onclick="goBackToTopics()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">‚¨ÖÔ∏è Back</button>
                        <button onclick="goHome()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">üè† Home</button>
                    </div>
                    <h2 id="topic-title" class="text-2xl font-bold text-sky-400"></h2>
                    <p class="text-xl font-semibold">Score: <span id="score">0</span></p>
                </div>
                <div id="loader-container" class="flex justify-center items-center h-64">
                    <div class="loader"></div>
                </div>
                <div id="qa-container" class="hidden">
                    <div class="min-h-[100px] bg-gray-900/50 p-4 rounded-lg mb-6 flex items-center justify-center">
                        <p id="question-text" class="text-2xl font-medium"></p>
                    </div>
                    <div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                    <div id="fun-fact-container" class="min-h-[80px] p-3 rounded-lg text-sky-300 italic text-center">
                        <p id="fun-fact-text"></p>
                    </div>
                </div>
                <button id="next-question-btn" class="hidden mt-4 w-full bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-3 px-6 rounded-lg">Next Question</button>
            </div>
        </div>
    </div>

    <script type="importmap">{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 1. AI AVATAR LOGIC ---
        const GOOGLE_API_KEY = 'AIzaSyAvqtVK1lvKclk9RpU9-qKufHVGfWsg_gw';
        const GOOGLE_CX_ID = '83c4d23e4411a429b';
        
        const scene=new THREE.Scene();scene.background=new THREE.Color(0xf0f2f5);const camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,1000);camera.position.set(0,1.5,5);const renderer=new THREE.WebGLRenderer({antialias:!0});
        document.getElementById('container').appendChild(renderer.domElement);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled=!0;const ambientLight=new THREE.AmbientLight(0xffffff,0.8);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(0xffffff,1);directionalLight.position.set(5,10,7.5);directionalLight.castShadow=!0;scene.add(directionalLight);const ground=new THREE.Mesh(new THREE.PlaneGeometry(10,10),new THREE.MeshStandardMaterial({color:0xcccccc}));ground.rotation.x=-Math.PI/2;ground.receiveShadow=!0;scene.add(ground);const controls=new OrbitControls(camera,renderer.domElement);controls.target.set(0,1,0);controls.update();let mixer,character;const animations=new Map();const clock=new THREE.Clock();const gltfLoader=new GLTFLoader();const chatInput=document.getElementById('chat-input');const askButton=document.getElementById('ask-btn');const micButton=document.getElementById('mic-btn');const stopButton=document.getElementById('stop-btn');const CHARACTER_MODEL_PATH='/static/character.glb';const IDLE_ANIM_NAME='idle',TALKING_ANIM_NAME='talk';gltfLoader.load(CHARACTER_MODEL_PATH,(gltf)=>{character=gltf.scene;scene.add(character);mixer=new THREE.AnimationMixer(character);gltf.animations.forEach((clip)=>{const clipName=clip.name.toLowerCase()==='jum'?'jump':clip.name.toLowerCase();animations.set(clipName,mixer.clipAction(clip))});if(animations.has(IDLE_ANIM_NAME))playAnimation(IDLE_ANIM_NAME)});
        let currentAnimation=null;let animationTimeout;
        
        // *** NEW: Step 1 -> Variable to store target rotation ***
        let targetRotationY = 0;

        function playAnimation(name,duration=null){const t=name.toLowerCase();if(!animations.has(t))return;clearTimeout(animationTimeout);const e=["idle","talk"].includes(t)||duration,o=animations.get(t);o.timeScale="dance"===t||"jump"===t||"walk"===t?.5:1;const i=currentAnimation?animations.get(currentAnimation):null;i&&i.fadeOut(.3),o.reset().setEffectiveWeight(1).fadeIn(.3).play(),o.loop=e?THREE.LoopRepeat:THREE.LoopOnce,o.clampWhenFinished=!e,currentAnimation=t,duration?animationTimeout=setTimeout(()=>{playAnimation("idle")},duration):e||mixer.addEventListener("finished",function t(){playAnimation("idle"),mixer.removeEventListener("finished",t)})}
        const visualOutputContainer=document.getElementById("visual-output-container");
        
        function openTriviaModal() {
            const triviaModal = document.getElementById('trivia-modal-overlay');
            if (triviaModal) {
                triviaModal.classList.remove('hidden'); 
                triviaModal.classList.remove('pointer-events-none');
                setTimeout(() => { 
                    triviaModal.classList.add('visible');
                    triviaModal.classList.add('animate-fadeInUp');
                }, 10);
            }
        }
        
        async function renderVisualOutput(data){
            if (data.spoken_text && data.spoken_text.toLowerCase().includes('trivia')) {
                data.type = 'play_trivia';
                data.spoken_text = "Great! Let's play some trivia. The game has appeared on your screen.";
            }
            if (data.type !== 'play_trivia') {
                clearVisuals();
            }
            switch(data.type){
                case"set_timer":createTimerWidget(data.seconds);break;
                case"open_camera":try{const t=await openCameraModal();displayCapturedPhoto(t.imageDataUrl),speakText(`Hey ${t.filename}, this is your image.`,!0),triggerAutoDownload(t.imageDataUrl,t.filename)}catch(t){speakText("Okay, maybe next time.",!0)}break;
                case "play_trivia": openTriviaModal(); break;
                case"animation_command":playAnimation(data.animation_name,5e3);break;
                case"sing_song":createTopTextContainer();break;
                case"math_sequence":renderMathSequence(data.elements);break;
                case"image_topic":renderImage(await fetchGoogleImage(data.search_term));break;
                case"comparison_topic":createTopTextContainer(),renderComparisonImages(data.entities);break;
                case"simple_text":default:createTopTextContainer()
            }
        }
        function createTopTextContainer(){const t=document.createElement("div");t.id="top-text-container",visualOutputContainer.appendChild(t)}async function renderComparisonImages(t){const e=t.map(t=>fetchGoogleImage(t.search_term)),n=await Promise.all(e),o=document.createElement("div");o.className="comparison-image-container left";const i=document.createElement("img");i.src=n[0],o.appendChild(i),visualOutputContainer.appendChild(o),n.length>1&&(()=>{const t=document.createElement("div");t.className="comparison-image-container right";const e=document.createElement("img");e.src=n[1],t.appendChild(e),visualOutputContainer.appendChild(t)})(),setTimeout(()=>{o.classList.add("visible"),visualOutputContainer.querySelector(".right")?.classList.add("visible")},50)}async function renderMathSequence(t){const e=document.createElement("div");e.className="math-container",visualOutputContainer.appendChild(e);for(const n of t){const t=document.createElement("span");t.className="math-element",t.textContent=n,e.appendChild(t),await new Promise(t=>setTimeout(t,50)),t.classList.add("visible"),await new Promise(t=>setTimeout(t,600))}}
        
        function renderImage(imageUrl) {
            const container = document.createElement("div");
            container.className = "image-topic-container";
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            container.appendChild(imgElement);
            visualOutputContainer.appendChild(container);
            setTimeout(() => container.classList.add("visible"), 100);
            createTopTextContainer();
        }

        function showLoadingIndicator(){clearVisuals(),createTopTextContainer(),document.getElementById("top-text-container").textContent="Thinking... ü§î"}function clearVisuals(){visualOutputContainer.innerHTML=""}
        
        async function fetchGoogleImage(searchTerm){
            const defaultPlaceholder = "https://picsum.photos/220/220?grayscale";
            if (GOOGLE_API_KEY.includes("PASTE_") || GOOGLE_CX_ID.includes("PASTE_")) {
                console.warn("‚ö†Ô∏è Google API keys not configured. Using placeholder simulation.");
                const lowerSearchTerm = searchTerm.toLowerCase();
                let category = lowerSearchTerm;
                if (lowerSearchTerm.includes("lion") || lowerSearchTerm.includes("tiger") || lowerSearchTerm.includes("dog") || lowerSearchTerm.includes("cat") || lowerSearchTerm.includes("animal")) { category = "animal " + lowerSearchTerm; } else if (lowerSearchTerm.includes("dinosaur") || lowerSearchTerm.includes("creature")) { category = "dinosaur art " + lowerSearchTerm; } else if (lowerSearchTerm.includes("flower") || lowerSearchTerm.includes("rose") || lowerSearchTerm.includes("plant") || lowerSearchTerm.includes("tree")) { category = "nature " + lowerSearchTerm; } else if (lowerSearchTerm.includes("fruit") || lowerSearchTerm.includes("apple") || lowerSearchTerm.includes("banana")) { category = "fruit " + lowerSearchTerm; } else if (lowerSearchTerm.includes("person") || lowerSearchTerm.includes("famous") || lowerSearchTerm.includes("actor") || lowerSearchTerm.includes("scientist")) { category = "portrait " + lowerSearchTerm; } else if (lowerSearchTerm.includes("fire") || lowerSearchTerm.includes("water") || lowerSearchTerm.includes("sand") || lowerSearchTerm.includes("element")) { category = "nature element " + lowerSearchTerm; } else if (lowerSearchTerm.includes("galaxy") || lowerSearchTerm.includes("universe") || lowerSearchTerm.includes("planet") || lowerSearchTerm.includes("star")) { category = "space " + lowerSearchTerm; } else if (lowerSearchTerm.includes("cartoon") || lowerSearchTerm.includes("movie character") || lowerSearchTerm.includes("superhero")) { category = "character art " + lowerSearchTerm; } else if (lowerSearchTerm.includes("car") || lowerSearchTerm.includes("house") || lowerSearchTerm.includes("non living")) { category = "object " + lowerSearchTerm; }
                return `https://source.unsplash.com/220x220/?${encodeURIComponent(category)}`;
            }
            const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX_ID}&q=${encodeURIComponent(searchTerm)}&searchType=image&num=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error(`Google API error! status: ${response.status}`); }
                const data = await response.json();
                if (data.items && data.items.length > 0) { return data.items[0].link; } else { console.warn("‚ö†Ô∏è No image found from Google for:", searchTerm); return defaultPlaceholder; }
            } catch (error) { console.error("üî¥ Error fetching image from Google API:", error); return defaultPlaceholder; }
        }

        async function processInput(t){askButton.disabled=!0,micButton.disabled=!0,showLoadingIndicator(),chatInput.value="",await callBackendAPI(t)}
        async function callBackendAPI(t){try{const e=await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();await renderVisualOutput(n),n.spoken_text&&"open_camera"!==n.type&&speakText(n.spoken_text,"animation_command"!==n.type)}catch(t){const e={spoken_text:"Oh no, my brain circuits are tangled!"};createTopTextContainer(),speakText(e.spoken_text,!0)}}
        function speakText(t,e){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(t),o=document.getElementById("top-text-container");if(o&&e){o.innerHTML="";const i=t.split(/\s+/),s=[];i.forEach(t=>{const e=document.createElement("span");e.className="caption-word",e.textContent=t,o.appendChild(e),s.push(e)});let l=0;n.onboundary=t=>{"word"===t.name&&l<s.length&&(s[l].classList.add("visible"),l++)}}
        e&&(n.onstart=()=>playAnimation("talk")),n.onend=()=>{if("talk"===currentAnimation&&playAnimation("idle"),askButton.disabled=!1,micButton.disabled=!1,o&&!document.getElementById("timer-widget")){o.querySelectorAll(".caption-word").forEach(t=>t.classList.add("visible"));setTimeout(clearVisuals,4e3)}},speechSynthesis.speak(n)}
        
        // --- 2. TIMER WIDGET LOGIC ---
        let timerInterval,timeRemainingInSeconds,isTimerPaused=!0,initialSeconds=0;
        function createTimerWidget(seconds){initialSeconds=seconds,timeRemainingInSeconds=seconds;if(isNaN(timeRemainingInSeconds)){console.error("Timer started with invalid seconds value:",seconds);timeRemainingInSeconds=0}const t=document.createElement("div");t.id="timer-widget",t.innerHTML=`\n                <div id="timer-display"></div>\n                <div id="timer-controls">\n                    <button id="timer-start-pause" class="timer-btn start">Start</button>\n                    <button id="timer-reset" class="timer-btn reset">Reset</button>\n                    <button id="timer-edit" class="timer-btn edit">Edit</button>\n                </div>\n            `,visualOutputContainer.appendChild(t),updateTimerDisplay(),document.getElementById("timer-start-pause").onclick=toggleTimer,document.getElementById("timer-reset").onclick=resetTimer,document.getElementById("timer-edit").onclick=editTimer}
        function updateTimerDisplay(){const t=document.getElementById("timer-display");if(t){const e=Math.floor(timeRemainingInSeconds/60),n=timeRemainingInSeconds%60;t.textContent=`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}}
        function toggleTimer(){if(isTimerPaused=!isTimerPaused,timeRemainingInSeconds<=0)return;const t=document.getElementById("timer-start-pause");isTimerPaused?(t.textContent="Start",t.className="timer-btn start",clearInterval(timerInterval)):(t.textContent="Pause",t.className="timer-btn pause",timerInterval=setInterval(tick,1e3))}
        function tick(){--timeRemainingInSeconds,updateTimerDisplay(),timeRemainingInSeconds<0&&(timeRemainingInSeconds=0),0===timeRemainingInSeconds&&(clearInterval(timerInterval),document.getElementById("timer-alarm").play(),setTimeout(()=>{clearVisuals(),speakText("Time's up! Your timer has finished.",!0)},4e3))}
        function resetTimer(){clearInterval(timerInterval),isTimerPaused=!0,createTimerWidget(initialSeconds)}
        function editTimer(){clearInterval(timerInterval),isTimerPaused=!0;const t=prompt(`Enter new time (e.g., '5m' for minutes or '30s' for seconds):`,`${Math.floor(initialSeconds/60)}m`);if(t){let e=0;t.toLowerCase().includes("m")?e=60*parseInt(t,10):t.toLowerCase().includes("s")?e=parseInt(t,10):!isNaN(parseInt(t,10))&&(e=60*parseInt(t,10)),e&&!isNaN(e)&&e>0?createTimerWidget(e):createTimerWidget(initialSeconds)}else createTimerWidget(initialSeconds)}
        stopButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearTimeout(animationTimeout),clearInterval(timerInterval),playAnimation("idle"),clearVisuals(),askButton.disabled=!1,micButton.disabled=!1});
        const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(SpeechRecognition){const t=new SpeechRecognition;t.continuous=!1,t.lang="en-US",t.interimResults=!1,micButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearVisuals(),chatInput.value="",t.start()}),t.onstart=()=>micButton.classList.add("listening"),t.onend=()=>micButton.classList.remove("listening"),t.onresult=e=>{const n=e.results[e.results.length-1][0].transcript.trim();chatInput.value=n,processInput(n)}}else micButton.style.display="none";
        askButton.addEventListener("click",()=>{const t=chatInput.value;t&&(speechSynthesis.cancel(),clearVisuals(),processInput(t))}),chatInput.addEventListener("keyup",t=>{t.key==="Enter"&&askButton.click()});
        
        // *** NEW: Step 2 -> Track the mouse and update the target rotation ***
        window.addEventListener('mousemove', (event) => {
            // Normalize mouse X position to a range of -1 to 1
            const normalizedX = (event.clientX / window.innerWidth) * 2 - 1;
            // Set the target rotation based on the normalized X position.
            // The 0.5 multiplier controls the sensitivity or max rotation angle.
            targetRotationY = normalizedX * 0.5;
        });
        
        function animate(){
            requestAnimationFrame(animate);
            const t = clock.getDelta();
            mixer && mixer.update(t);

            // *** NEW: Step 3 -> Smoothly animate the avatar's rotation in the render loop ***
            if (character) {
                // This creates a smooth "damping" effect
                // The character's current rotation moves a small fraction (0.05) of the way
                // towards the target rotation on each frame.
                character.rotation.y += (targetRotationY - character.rotation.y) * 0.05;
            }

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});

        // --- 3. TRIVIA GAME LOGIC ---
        const triviaModalOverlay = document.getElementById('trivia-modal-overlay');
        const topicSelectionView = document.getElementById('topic-selection');
        const gameView = document.getElementById('game-view');
        const topicTitleEl = document.getElementById('topic-title');
        const scoreEl = document.getElementById('score');
        const loaderContainer = document.getElementById('loader-container');
        const qaContainer = document.getElementById('qa-container');
        const questionTextEl = document.getElementById('question-text');
        const answersGridEl = document.getElementById('answers-grid');
        const funFactTextEl = document.getElementById('fun-fact-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        let currentTopic = '';
        let score = 0;
        let currentCorrectAnswer = '';
        let currentTopicQuestions = []; 
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        window.goHome = function() {
            triviaModalOverlay.classList.remove('visible');
            setTimeout(() => {
                triviaModalOverlay.classList.add('hidden');
                triviaModalOverlay.classList.add('pointer-events-none');
                gameView.classList.add('hidden');
                topicSelectionView.classList.remove('hidden');
            }, 300); 
        }
        window.goBackToTopics = function() {
            gameView.classList.add('hidden');
            topicSelectionView.classList.remove('hidden');
            topicSelectionView.classList.add('animate-fadeInUp');
        }
        window.startGame = function(topic) {
            currentTopic = topic;
            score = 0;
            scoreEl.textContent = score;
            topicTitleEl.textContent = topic;
            const questionsForTopic = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
            shuffleArray(questionsForTopic);
            currentTopicQuestions = questionsForTopic;
            topicSelectionView.classList.add('hidden');
            gameView.classList.remove('hidden');
            gameView.classList.add('animate-fadeInUp');
            fetchNewQuestion();
        }
        function fetchNewQuestion() {
            qaContainer.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            funFactTextEl.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            answersGridEl.innerHTML = '';
            setTimeout(() => {
                const backupData = getBackupQuestion(currentTopic);
                if (backupData) {
                    displayQuestion(backupData);
                } else {
                    questionTextEl.textContent = "You're a trivia master! Let's start this topic over.";
                    answersGridEl.innerHTML = '';
                    setTimeout(fetchNewQuestion, 2000); 
                }
            }, 600); 
        }
        function getBackupQuestion(topic) {
            if (currentTopicQuestions.length === 0) {
                console.log("Reshuffling questions for topic:", topic);
                const originalQuestions = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
                shuffleArray(originalQuestions);
                currentTopicQuestions = originalQuestions;
            }
            return currentTopicQuestions.pop();
        }
        function displayQuestion(data) {
            questionTextEl.textContent = data.question;
            currentCorrectAnswer = data.correct_answer;
            qaContainer.classList.remove('animate-fadeInUp');
            void qaContainer.offsetWidth; 
            qaContainer.classList.add('animate-fadeInUp');
            data.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-btn w-full p-4 bg-gray-700 rounded-lg text-lg font-semibold';
                button.onclick = () => checkAnswer(button, option, data.fun_fact);
                answersGridEl.appendChild(button);
            });
            loaderContainer.classList.add('hidden');
            qaContainer.classList.remove('hidden');
        }
        function checkAnswer(buttonEl, selectedOption, funFact) {
            const answerButtons = answersGridEl.querySelectorAll('.answer-btn');
            answerButtons.forEach(btn => btn.disabled = true);
            const animationClass = selectedOption === currentCorrectAnswer ? 'animate-pulseCorrect' : 'animate-shakeIncorrect';
            buttonEl.classList.add(animationClass);
            buttonEl.addEventListener('animationend', () => buttonEl.classList.remove(animationClass), { once: true });
            
            if (selectedOption === currentCorrectAnswer) {
                score++;
                scoreEl.textContent = score;
                buttonEl.classList.add('correct');
            } else {
                buttonEl.classList.add('incorrect');
                answerButtons.forEach(btn => {
                    if (btn.textContent === currentCorrectAnswer) btn.classList.add('correct');
                });
            }
            funFactTextEl.textContent = `üí° Fun Fact: ${funFact}`;
            nextQuestionBtn.classList.remove('hidden');
        }
        nextQuestionBtn.addEventListener('click', fetchNewQuestion);
        const backupQuestions = {
            'General Knowledge': [{ "question": "What is the capital of France?", "options": ["London", "Berlin", "Paris", "Madrid"], "correct_answer": "Paris", "fun_fact": "Paris is often called the 'City of Light' (La Ville Lumi√®re)." }, { "question": "How many colors are in a rainbow?", "options": ["5", "7", "8", "6"], "correct_answer": "7", "fun_fact": "The colors are Red, Orange, Yellow, Green, Blue, Indigo, and Violet." }, { "question": "Which is the largest ocean on Earth?", "options": ["Atlantic", "Indian", "Arctic", "Pacific"], "correct_answer": "Pacific", "fun_fact": "The Pacific Ocean covers about 30% of the Earth's surface." }],
            'Science Fun': [{ "question": "What planet is known as the Red Planet?", "options": ["Earth", "Mars", "Jupiter", "Saturn"], "correct_answer": "Mars", "fun_fact": "Mars has two small moons, Phobos and Deimos." }, { "question": "What force pulls objects towards the Earth?", "options": ["Magnetism", "Friction", "Gravity", "Inertia"], "correct_answer": "Gravity", "fun_fact": "Gravity is what gives weight to objects." }, { "question": "What do plants use to make their own food?", "options": ["Photosynthesis", "Respiration", "Digestion", "Evaporation"], "correct_answer": "Photosynthesis", "fun_fact": "During photosynthesis, plants release oxygen, which we need to breathe." }],
            'History & Myths': [{ "question": "Who was the first person to walk on the moon?", "options": ["Buzz Aldrin", "Yuri Gagarin", "Michael Collins", "Neil Armstrong"], "correct_answer": "Neil Armstrong", "fun_fact": "His famous words were, 'That's one small step for man, one giant leap for mankind.'" }, { "question": "In Greek mythology, who is the king of the gods?", "options": ["Hades", "Poseidon", "Zeus", "Apollo"], "correct_answer": "Zeus", "fun_fact": "Zeus's Roman equivalent is Jupiter." }],
            'World Explorer': [{ "question": "Which is the longest river in the world?", "options": ["Amazon", "Nile", "Yangtze", "Mississippi"], "correct_answer": "Nile", "fun_fact": "The Nile River flows through 11 countries in Africa." }, { "question": "What is the name of the tallest mountain in the world?", "options": ["K2", "Kangchenjunga", "Mount Everest", "Lhotse"], "correct_answer": "Mount Everest", "fun_fact": "Mount Everest is located in the Himalayas on the border of Nepal and China." }],
            'Math & Logic': [{ "question": "How many sides does a triangle have?", "options": ["3", "4", "5", "6"], "correct_answer": "3", "fun_fact": "The sum of the angles in a triangle is always 180 degrees." }, { "question": "What is 15 + 25?", "options": ["30", "35", "40", "45"], "correct_answer": "40", "fun_fact": "Addition is one of the four basic operations of arithmetic." }],
            'Aptitude Puzzles': [{ "question": "Which number comes next in the series: 2, 4, 6, 8, ...?", "options": ["9", "10", "12", "11"], "correct_answer": "10", "fun_fact": "This is a simple series of even numbers, increasing by 2 each time." }, { "question": "If a train travels 60 miles in 1 hour, how many miles does it travel in 30 minutes?", "options": ["15", "30", "45", "60"], "correct_answer": "30", "fun_fact": "30 minutes is half an hour, so the train would travel half the distance." }]
        };

        // --- 4. CAMERA MODAL LOGIC ---
        const cameraModalOverlay = document.getElementById('camera-modal-overlay');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const videoFeed = document.getElementById('video-feed');
        const mainCanvas = document.getElementById('main-canvas');
        const photoCanvas = document.getElementById('photo-canvas');
        const cameraTimerDisplay = document.getElementById('camera-timer-display');
        const takePhotoButton = document.getElementById('take-photo-button');
        const saveButton = document.getElementById('save-button');
        const retakeButton = document.getElementById('retake-button');
        const saveModal = document.getElementById('save-modal');
        const filenameInput = document.getElementById('filename-input');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const cameraView = document.getElementById('camera-view');
        const editingView = document.getElementById('editing-view');
        const flashOverlay = document.getElementById('flash-overlay');
        const sizeControlContainer = document.getElementById('size-control-container');
        const sizeSlider = document.getElementById('size-slider');
        let stream, currentFilter="none", capturedImage, ctx=mainCanvas.getContext("2d");
        let selectedObject = null, isDragging = false, dragStart = {x:0, y:0}, objectStart = {x:0, y:0};
        function openCameraModal(){return new Promise((t,e)=>{cameraModalOverlay.classList.remove("hidden"),setTimeout(()=>cameraModalOverlay.classList.add("visible"),10),startCamera();const n=()=>{saveModal.classList.remove("hidden")},o=()=>{let o=filenameInput.value.trim()||"avatar-photo",i=mainCanvas.toDataURL("image/jpeg");s(),r(),t({imageDataUrl:i,filename:o})},i=()=>{saveModal.classList.add("hidden")},s=()=>{cameraModalOverlay.classList.remove("visible"),setTimeout(()=>cameraModalOverlay.classList.add("hidden"),500),stopCamera(),retakeButton.click()},r=()=>{saveButton.removeEventListener("click",n),modalSaveBtn.removeEventListener("click",o),modalCancelBtn.removeEventListener("click",i),closeCameraBtn.removeEventListener("click",a)},a=()=>{s(),r(),e("Camera closed by user")};saveButton.addEventListener("click",n),modalSaveBtn.addEventListener("click",o),modalCancelBtn.addEventListener("click",i),closeCameraBtn.addEventListener("click",a)})}
        function displayCapturedPhoto(imageDataUrl){const t=document.getElementById("captured-photo-container");t&&t.remove();const e=document.createElement("div");e.id="captured-photo-container";const n=document.createElement("img");n.src=imageDataUrl,e.appendChild(n),visualOutputContainer.appendChild(e),setTimeout(()=>e.classList.add("visible"),100)}
        function triggerAutoDownload(t,e){const n=document.createElement("a");n.href=t,n.download=`${e}.jpeg`,n.click()}
        async function startCamera(){try{stream=await navigator.mediaDevices.getUserMedia({video:!0}),videoFeed.srcObject=stream,await videoFeed.play(),cameraView.classList.remove("hidden"),editingView.classList.add("hidden"),editingView.classList.remove("flex"),takePhotoButton.classList.remove("hidden")}catch(t){console.error("Error accessing camera: ",t)}}
        function stopCamera(){stream&&stream.getTracks().forEach(t=>t.stop())}
        function startTimer(){let t=3;cameraTimerDisplay.textContent=t,cameraTimerDisplay.classList.remove("hidden"),takePhotoButton.classList.add("hidden");const e=setInterval(()=>{t--,cameraTimerDisplay.textContent=t,0===t&&(clearInterval(e),cameraTimerDisplay.classList.add("hidden"),capturePhoto())},1e3)}
        function capturePhoto(){photoCanvas.width=videoFeed.videoWidth,photoCanvas.height=videoFeed.videoHeight;const t=photoCanvas.getContext("2d");t.drawImage(videoFeed,0,0,photoCanvas.width,photoCanvas.height),capturedImage=new Image,capturedImage.src=photoCanvas.toDataURL("image/jpeg"),capturedImage.onload=()=>{mainCanvas.width=capturedImage.width,mainCanvas.height=capturedImage.height,ctx.drawImage(capturedImage,0,0),cameraView.classList.add("hidden"),editingView.classList.remove("hidden"),editingView.classList.add("flex"),stopCamera(),flashEffect()}}
        function flashEffect(){flashOverlay.style.width=`${mainCanvas.offsetWidth}px`,flashOverlay.style.height=`${mainCanvas.offsetHeight}px`,flashOverlay.style.left=`${mainCanvas.offsetLeft}px`,flashOverlay.style.top=`${mainCanvas.offsetTop}px`,flashOverlay.classList.remove("hidden"),flashOverlay.classList.add("flash"),setTimeout(()=>{flashOverlay.classList.add("hidden"),flashOverlay.classList.remove("flash")},500)}
        function redrawCanvas(){ctx.clearRect(0,0,mainCanvas.width,mainCanvas.height),ctx.filter=currentFilter,ctx.drawImage(capturedImage,0,0,mainCanvas.width,mainCanvas.height),ctx.filter="none";if(selectedObject){const{type:t,value:e,size:n,position:o}=selectedObject;"emoji"===t&&(ctx.font=`${n}px serif`,ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(e,o.x,o.y))}}
        document.querySelectorAll(".filter-button").forEach(t=>{t.addEventListener("click",()=>{switch(t.dataset.filter){case"none":currentFilter="none";break;case"grayscale":currentFilter="grayscale(1)";break;case"sepia":currentFilter="sepia(1)";break;case"invert":currentFilter="invert(1)";break;case"saturate":currentFilter="saturate(200%)";break;case"contrast":currentFilter="contrast(200%)";break;case"brightness":currentFilter="brightness(150%)";break;case"blur":currentFilter="blur(5px)";break}redrawCanvas()})});
        function selectObject(t,e){selectedObject={type:t,value:e,size:parseInt(sizeSlider.value),position:{x:mainCanvas.width/2,y:mainCanvas.height/2}},sizeControlContainer.classList.remove("hidden"),redrawCanvas()}
        document.querySelectorAll(".emoji-button").forEach(t=>t.addEventListener("click",()=>selectObject("emoji",t.dataset.emoji))),sizeSlider.addEventListener("input",t=>{selectedObject&&(selectedObject.size=parseInt(t.target.value),redrawCanvas())});
        mainCanvas.addEventListener('mousedown', e => { if (selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; const { position, size } = selectedObject; if (mouseX > position.x - size / 2 && mouseX < position.x + size / 2 && mouseY > position.y - size / 2 && mouseY < position.y + size / 2) { isDragging = true; mainCanvas.style.cursor = 'grabbing'; dragStart.x = mouseX; dragStart.y = mouseY; objectStart.x = position.x; objectStart.y = position.y; } } });
        mainCanvas.addEventListener('mousemove', e => { if (isDragging && selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; selectedObject.position.x = objectStart.x + (mouseX - dragStart.x); selectedObject.position.y = objectStart.y + (mouseY - dragStart.y); redrawCanvas(); } });
        mainCanvas.addEventListener('mouseup', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        mainCanvas.addEventListener('mouseleave', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        closeCameraBtn.addEventListener('click', ()=>{const e=document.createEvent("Event");e.initEvent("manualclose",!0,!0),closeCameraBtn.dispatchEvent(e)});
        takePhotoButton.addEventListener('click', startTimer);
        retakeButton.addEventListener("click",()=>{currentFilter="none",selectedObject=null,sizeControlContainer.classList.add("hidden"),sizeSlider.value=96,startCamera()});
        saveButton.addEventListener('click',()=>saveModal.classList.remove("hidden"));
        modalCancelBtn.addEventListener('click',()=>saveModal.classList.add("hidden"));
        modalSaveBtn.addEventListener("click",()=>{const t=document.createEvent("Event");t.initEvent("manualsave",!0,!0),modalSaveBtn.dispatchEvent(t)});
    </script>
</body>
</html> -->


    <!-- index.html -->
<!-- 
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual AI Avatar</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');
    </style>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f2f5; color: #1c1e21; height: 100vh; overflow: hidden; }
        #avatar-main-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #header { width: 100%; background-color: #fff; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,.1); text-align: center; z-index: 10; }
        h1 { margin: 0; font-size: 1.5rem; color: #4a4a4a; }
        #container { width: 100%; height: 100%; position: relative; }
        #chat-container { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; background-color: rgba(255,255,255,.95); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.15); width: 90%; max-width: 600px; align-items: center; z-index: 101; }
        #chat-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 8px; padding: 12px; font-size: 1rem; }
        .chat-btn { padding: 12px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color .3s ease, transform .1s ease; }
        #ask-btn { background-color: #007bff; color: #fff; padding-left: 20px; padding-right: 20px; }
        #mic-btn { background-color: #28a745; }
        #stop-btn { background-color: #dc3545; }
        #visual-output-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .math-container{display:flex;flex-direction:row;gap:2vw;align-items:center;position:absolute;top:5vh;left:50%;transform:translateX(-50%)}
        .math-element{font-size:clamp(3rem,10vw,7rem);font-weight:700;color:#333;text-shadow:2px 2px 5px rgba(0,0,0,.2);opacity:0;transform:translateY(50px) scale(.5);transition:all .5s cubic-bezier(.34,1.56,.64,1)}
        .math-element.visible{opacity:1;transform:translateY(0) scale(1)}
        .comparison-image-container{position:absolute;top:50%;transform:translateY(-50%) scale(.5);opacity:0;transition:all .6s cubic-bezier(.16,1,.3,1)}
        .comparison-image-container.left{left:10vw}
        .comparison-image-container.right{right:10vw}
        .comparison-image-container.visible{transform:translateY(-50%) scale(1);opacity:1}
        .comparison-image-container img{width:clamp(150px,18vw,250px);height:clamp(150px,18vw,250px);border-radius:15px;object-fit:cover;border:5px solid #fff;box-shadow:0 10px 20px rgba(0,0,0,.2)}
        #captured-photo-container { position: absolute; left: 40px; bottom: 120px; width: 220px; height: 220px; padding: 10px; background-color: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transform: translateY(100%); transition: all .6s cubic-bezier(.16,1,.3,1); }
        #captured-photo-container.visible { opacity: 1; transform: translateY(0); }
        #captured-photo-container img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
        .image-topic-container{position:absolute;left:40px;bottom:120px;display:flex;align-items:center;gap:20px;opacity:0;transform:translateY(100%);transition:all .6s cubic-bezier(.16,1,.3,1)}
        .image-topic-container.visible{opacity:1;transform:translateY(0)}
        .image-topic-container img{width:220px;height:220px;padding:10px;background-color:white;border-radius:15px;object-fit:cover;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
        #top-text-container{position:absolute;top:3vh;left:50%;transform:translateX(-50%);width:90%;max-width:900px;text-align:center;font-size:1.8rem;font-weight:600;color:#333; text-shadow: 1px 1px 3px rgba(255,255,255,0.7);}
        .caption-word{display:inline-block;opacity:0;transform:translateY(10px);transition:opacity .4s ease,transform .4s ease;margin-right:.4rem}
        .caption-word.visible{opacity:1;transform:translateY(0)}
        #timer-widget { pointer-events: auto; position: absolute; top: 3vh; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.95); padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; gap: 0.75rem; width: 300px; }
        #timer-display { font-size: 3.5rem; font-weight: 700; color: #333; font-family: 'Inter', sans-serif, monospace; }
        #timer-controls { display: flex; gap: 0.5rem; }
        .timer-btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .timer-btn.start { background-color: #28a745; }
        .timer-btn.pause { background-color: #ffc107; }
        .timer-btn.reset { background-color: #dc3545; }
        .timer-btn.edit { background-color: #6c757d; }
        #camera-modal-overlay { font-family: 'Inter', sans-serif; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        #camera-modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .camera-container { max-width: 600px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; position: relative; background-color: #1e293b; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: translateY(100vh); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #camera-modal-overlay.visible .camera-container { transform: translateY(0); }
        #editing-view { overflow-y: auto; }
        @keyframes flash-effect { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .flash { animation: flash-effect 0.5s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background-color: #1e293b; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        
        #trivia-modal-overlay {
            background-color: #0f172a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 20px 20px;
            color: #fff;
            transition: opacity 0.3s ease;
        }
        #trivia-modal-overlay.visible { opacity: 1; }
        #trivia-container {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            width: 100%;
            max-width: 48rem;
            margin: auto;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .topic-btn, #next-question-btn { transition: all 0.3s ease-in-out; border: 1px solid transparent; cursor: pointer; }
        .topic-btn:hover, #next-question-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.5);
            border-color: rgba(59, 130, 246, 0.8);
        }
        .answer-btn { transition: all 0.2s ease-in-out; border: 1px solid #4b5563; }
        .answer-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            border-color: #3b82f6;
            background-color: #374151;
        }
        .correct {
            background-image: linear-gradient(to right, #22c55e, #16a34a) !important;
            border-color: #86efac !important;
            color: white !important;
        }
        .incorrect {
            background-image: linear-gradient(to right, #ef4444, #dc2626) !important;
            border-color: #fca5a5 !important;
            color: white !important;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shakeIncorrect { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-pulseCorrect { animation: pulseCorrect 0.7s ease-in-out; }
        .animate-shakeIncorrect { animation: shakeIncorrect 0.6s ease-in-out; }
        .loader {
            border: 4px solid #4b5563;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div id="avatar-main-container">
        <div id="header"><h1>Visual AI Avatar</h1></div>
        <div id="container">
            <div id="visual-output-container"></div>
            <div id="chat-container">
                <input type="text" id="chat-input" placeholder="Type or use the mic..."><button id="ask-btn" class="chat-btn">‚ú® Ask</button><button id="mic-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="white"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg></button><button id="stop-btn" class="chat-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="white"><path d="M6 6h12v12H6z"/></svg></button>
            </div>
        </div>
    </div>
    <audio id="timer-alarm" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>
    
    <div id="camera-modal-overlay" class="hidden">
        <div class="camera-container">
            <button id="close-camera-btn" class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-full text-sm z-10">Close</button>
            <h1 class="text-3xl font-bold mb-6 text-center text-indigo-400 shrink-0">AI Avatar Camera</h1>
            <div id="camera-view" class="w-full h-auto flex flex-col items-center">
                <video id="video-feed" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6" autoplay playsinline></video>
                <div id="camera-timer-display" class="text-5xl font-extrabold text-white mb-6 hidden"></div>
                <button id="take-photo-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-full">Take a Photo</button>
            </div>
            <div id="editing-view" class="w-full h-auto hidden flex-col items-center">
                <canvas id="main-canvas" class="w-full h-auto rounded-xl shadow-lg border-4 border-slate-700 mb-6 cursor-grab"></canvas>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Filters</h2>
                    <div class="flex justify-center flex-wrap gap-2">
                        <button data-filter="none" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">None</button>
                        <button data-filter="grayscale" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Grayscale</button>
                        <button data-filter="sepia" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Sepia</button>
                        <button data-filter="invert" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Invert</button>
                        <button data-filter="saturate" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Saturate</button>
                        <button data-filter="contrast" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Contrast</button>
                        <button data-filter="brightness" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Bright</button>
                        <button data-filter="blur" class="filter-button bg-slate-600 text-white font-bold py-2 px-4 rounded-full">Blur</button>
                    </div>
                </div>
                <div class="w-full mb-4">
                    <h2 class="text-xl font-bold mb-2 text-center text-slate-300">Emojis</h2>
                    <div class="flex justify-center flex-wrap gap-4 text-4xl">
                        <span class="emoji-button" data-emoji="üòé">üòé</span><span class="emoji-button" data-emoji="üòÇ">üòÇ</span><span class="emoji-button" data-emoji="ü§©">ü§©</span><span class="emoji-button" data-emoji="ü•≥">ü•≥</span><span class="emoji-button" data-emoji="ü§Ø">ü§Ø</span><span class="emoji-button" data-emoji="üòç">üòç</span><span class="emoji-button" data-emoji="üëç">üëç</span><span class="emoji-button" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
                    </div>
                </div>
                <div id="size-control-container" class="w-full mb-6 hidden">
                    <label for="size-slider" class="text-lg font-bold mb-2 block text-center text-slate-300">Adjust Size</label>
                    <input id="size-slider" type="range" min="20" max="300" value="96" class="w-3/4 mx-auto block">
                </div>
                <div id="photo-actions" class="mt-4 space-x-4 shrink-0">
                    <button id="save-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save Photo</button>
                    <button id="retake-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Retake</button>
                </div>
            </div>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div id="flash-overlay" class="absolute inset-0 bg-white rounded-xl hidden"></div>
        </div>
        <div id="save-modal" class="modal-overlay hidden">
            <div class="modal-content text-center">
                <h2 class="text-xl font-bold mb-4">What's your name?</h2>
                <input type="text" id="filename-input" class="w-full rounded-md px-4 py-2 mb-4 bg-slate-700 border border-slate-600 text-white" placeholder="e.g., Alex">
                <div class="flex justify-center space-x-4">
                    <button id="modal-save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full">Save</button>
                    <button id="modal-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="trivia-modal-overlay" class="fixed inset-0 p-4 flex items-center justify-center z-[1000] opacity-0 pointer-events-none hidden">
        <div id="trivia-container" class="relative">
            <div id="topic-selection">
                <button onclick="goHome()" class="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 z-10">üè† Home</button>
                <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-blue-500">AI Student Trivia</h1>
                <p class="text-gray-400 mb-8">For students aged 6-14. Pick a topic to start!</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="startGame('General Knowledge')" class="topic-btn p-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl text-lg md:text-xl font-semibold">üß† General Knowledge</button>
                    <button onclick="startGame('Science Fun')" class="topic-btn p-6 bg-gradient-to-br from-green-500 to-green-600 rounded-xl text-lg md:text-xl font-semibold">üî¨ Science Fun</button>
                    <button onclick="startGame('History & Myths')" class="topic-btn p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl text-lg md:text-xl font-semibold">üìú History & Myths</button>
                    <button onclick="startGame('World Explorer')" class="topic-btn p-6 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl text-lg md:text-xl font-semibold">üåç World Explorer</button>
                    <button onclick="startGame('Math & Logic')" class="topic-btn p-6 bg-gradient-to-br from-red-500 to-red-600 rounded-xl text-lg md:text-xl font-semibold">‚ûï Math & Logic</button>
                    <button onclick="startGame('Aptitude Puzzles')" class="topic-btn p-6 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl text-lg md:text-xl font-semibold">ü§î Aptitude Puzzles</button>
                </div>
            </div>
            <div id="game-view" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-2">
                        <button onclick="goBackToTopics()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">‚¨ÖÔ∏è Back</button>
                        <button onclick="goHome()" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">üè† Home</button>
                    </div>
                    <h2 id="topic-title" class="text-2xl font-bold text-sky-400"></h2>
                    <p class="text-xl font-semibold">Score: <span id="score">0</span></p>
                </div>
                <div id="loader-container" class="flex justify-center items-center h-64">
                    <div class="loader"></div>
                </div>
                <div id="qa-container" class="hidden">
                    <div class="min-h-[100px] bg-gray-900/50 p-4 rounded-lg mb-6 flex items-center justify-center">
                        <p id="question-text" class="text-2xl font-medium"></p>
                    </div>
                    <div id="answers-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                    <div id="fun-fact-container" class="min-h-[80px] p-3 rounded-lg text-sky-300 italic text-center">
                        <p id="fun-fact-text"></p>
                    </div>
                </div>
                <button id="next-question-btn" class="hidden mt-4 w-full bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-3 px-6 rounded-lg">Next Question</button>
            </div>
        </div>
    </div>

    <script type="importmap">{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 1. AI AVATAR LOGIC ---
        const GOOGLE_API_KEY = 'AIzaSyAvqtVK1lvKclk9RpU9-qKufHVGfWsg_gw';
        const GOOGLE_CX_ID = '83c4d23e4411a429b';
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f2f5);
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.5, 5);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        document.getElementById('container').appendChild(renderer.domElement);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 7.5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({ color: 0xcccccc }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);
        
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.update();
        
        let mixer, character;
        const animations = new Map();
        const clock = new THREE.Clock();
        const gltfLoader = new GLTFLoader();
        
        const textureLoader = new THREE.TextureLoader();

        const chatInput = document.getElementById('chat-input');
        const askButton = document.getElementById('ask-btn');
        const micButton = document.getElementById('mic-btn');
        const stopButton = document.getElementById('stop-btn');
        
        const CHARACTER_MODEL_PATH = '/static/character.glb';
        const IDLE_ANIM_NAME = 'idle', TALKING_ANIM_NAME = 'talk';
        
        gltfLoader.load(CHARACTER_MODEL_PATH, (gltf) => {
            character = gltf.scene;
            scene.add(character);
            mixer = new THREE.AnimationMixer(character);
            gltf.animations.forEach((clip) => {
                const clipName = clip.name.toLowerCase() === 'jum' ? 'jump' : clip.name.toLowerCase();
                animations.set(clipName, mixer.clipAction(clip))
            });
            if (animations.has(IDLE_ANIM_NAME)) playAnimation(IDLE_ANIM_NAME)
        });

        let currentAnimation = null;
        let animationTimeout;
        let targetRotationY = 0;

        function playAnimation(name, duration = null) {
            const t = name.toLowerCase();
            if (!animations.has(t)) return;
            clearTimeout(animationTimeout);
            const e = ["idle", "talk"].includes(t) || duration,
                o = animations.get(t);
            o.timeScale = "dance" === t || "jump" === t || "walk" === t ? .5 : 1;
            const i = currentAnimation ? animations.get(currentAnimation) : null;
            i && i.fadeOut(.3), o.reset().setEffectiveWeight(1).fadeIn(.3).play(), o.loop = e ? THREE.LoopRepeat : THREE.LoopOnce, o.clampWhenFinished = !e, currentAnimation = t, duration ? animationTimeout = setTimeout(() => { playAnimation("idle") }, duration) : e || mixer.addEventListener("finished", function t() { playAnimation("idle"), mixer.removeEventListener("finished", t) })
        }
        
        const visualOutputContainer = document.getElementById("visual-output-container");

        function openTriviaModal() {
            const triviaModal = document.getElementById('trivia-modal-overlay');
            if (triviaModal) {
                triviaModal.classList.remove('hidden');
                triviaModal.classList.remove('pointer-events-none');
                setTimeout(() => {
                    triviaModal.classList.add('visible');
                    triviaModal.classList.add('animate-fadeInUp');
                }, 10);
            }
        }
        
        async function renderVisualOutput(data) {
            if (data.spoken_text && data.spoken_text.toLowerCase().includes('trivia')) {
                data.type = 'play_trivia';
                data.spoken_text = "Great! Let's play some trivia. The game has appeared on your screen.";
            }

            // MODIFICATION 2: Call the less destructive `clearOverlays` function
            if (data.type !== 'play_trivia') {
                clearOverlays();
            }

            switch (data.type) {
                // MODIFICATION 2: Add a case to handle a full view reset
                case "reset_view": 
                    resetSceneAndVisuals(); 
                    break;
                case "set_timer": createTimerWidget(data.seconds); break;
                case "open_camera": try { const t = await openCameraModal(); displayCapturedPhoto(t.imageDataUrl), speakText(`Hey ${t.filename}, this is your image.`, !0), triggerAutoDownload(t.imageDataUrl, t.filename) } catch (t) { speakText("Okay, maybe next time.", !0) } break;
                case "play_trivia": openTriviaModal(); break;
                case "animation_command": playAnimation(data.animation_name, 5e3); break;
                case "sing_song": createTopTextContainer(); break;
                case "math_sequence": renderMathSequence(data.elements); break;
                case "image_topic": renderImage(await fetchGoogleImage(data.search_term)); break;
                case "comparison_topic": createTopTextContainer(), renderComparisonImages(data.entities); break;
                case "change_background":
                    if (data.image_url) {
                        changeSceneBackground(data.image_url);
                    }
                    createTopTextContainer();
                    break;
                case "simple_text":
                default: createTopTextContainer()
            }
        }

        function changeSceneBackground(imageUrl) {
            const topText = document.getElementById("top-text-container") || createTopTextContainer();
            topText.textContent = "Traveling...";

            textureLoader.load(
                imageUrl,
                (texture) => {
                    texture.mapping = THREE.EquirectangularReflectionMapping;
                    scene.background = texture;
                    scene.environment = texture;
                    ground.visible = false;
                    topText.textContent = "";
                },
                undefined,
                (err) => {
                    console.error('Error loading background texture:', err);
                    speakText("I had some trouble loading that scene. Let's stay here for now.", true);
                    scene.background = new THREE.Color(0xf0f2f5);
                    ground.visible = true;
                }
            );
        }

        function createTopTextContainer() { 
            const t = document.createElement("div"); 
            t.id = "top-text-container", visualOutputContainer.appendChild(t);
            return t;
        }
        
        async function renderComparisonImages(t) { const e = t.map(t => fetchGoogleImage(t.search_term)), n = await Promise.all(e), o = document.createElement("div"); o.className = "comparison-image-container left"; const i = document.createElement("img"); i.src = n[0], o.appendChild(i), visualOutputContainer.appendChild(o), n.length > 1 && (() => { const t = document.createElement("div"); t.className = "comparison-image-container right"; const e = document.createElement("img"); e.src = n[1], t.appendChild(e), visualOutputContainer.appendChild(t) })(), setTimeout(() => { o.classList.add("visible"), visualOutputContainer.querySelector(".right")?.classList.add("visible") }, 50) } async function renderMathSequence(t) { const e = document.createElement("div"); e.className = "math-container", visualOutputContainer.appendChild(e); for (const n of t) { const t = document.createElement("span"); t.className = "math-element", t.textContent = n, e.appendChild(t), await new Promise(t => setTimeout(t, 50)), t.classList.add("visible"), await new Promise(t => setTimeout(t, 600)) } }

        function renderImage(imageUrl) {
            const container = document.createElement("div");
            container.className = "image-topic-container";
            const imgElement = document.createElement("img");
            imgElement.src = imageUrl;
            container.appendChild(imgElement);
            visualOutputContainer.appendChild(container);
            setTimeout(() => container.classList.add("visible"), 100);
            createTopTextContainer();
        }

        function showLoadingIndicator() { clearOverlays(), createTopTextContainer(), document.getElementById("top-text-container").textContent = "Thinking... ü§î" }
        
        // MODIFICATION 1: Replace `clearVisuals` with two new functions
        
        // New function to ONLY clear HTML elements, leaving the 3D background intact.
        function clearOverlays() {
            visualOutputContainer.innerHTML = "";
        }
        
        // New function for a FULL reset, including the 3D background.
        function resetSceneAndVisuals() {
            clearOverlays(); // First, clear the HTML elements
            // Then, reset the scene background to the default
            if (scene.background && scene.background.isTexture) {
                scene.background = new THREE.Color(0xf0f2f5);
                scene.environment = null;
                ground.visible = true;
            }
        }
        
        async function fetchGoogleImage(searchTerm){
            const defaultPlaceholder = "https://picsum.photos/220/220?grayscale";
            if (GOOGLE_API_KEY.includes("PASTE_") || GOOGLE_CX_ID.includes("PASTE_")) {
                console.warn("‚ö†Ô∏è Google API keys not configured. Using placeholder simulation.");
                const lowerSearchTerm = searchTerm.toLowerCase();
                let category = lowerSearchTerm;
                if (lowerSearchTerm.includes("lion") || lowerSearchTerm.includes("tiger") || lowerSearchTerm.includes("dog") || lowerSearchTerm.includes("cat") || lowerSearchTerm.includes("animal")) { category = "animal " + lowerSearchTerm; } else if (lowerSearchTerm.includes("dinosaur") || lowerSearchTerm.includes("creature")) { category = "dinosaur art " + lowerSearchTerm; } else if (lowerSearchTerm.includes("flower") || lowerSearchTerm.includes("rose") || lowerSearchTerm.includes("plant") || lowerSearchTerm.includes("tree")) { category = "nature " + lowerSearchTerm; } else if (lowerSearchTerm.includes("fruit") || lowerSearchTerm.includes("apple") || lowerSearchTerm.includes("banana")) { category = "fruit " + lowerSearchTerm; } else if (lowerSearchTerm.includes("person") || lowerSearchTerm.includes("famous") || lowerSearchTerm.includes("actor") || lowerSearchTerm.includes("scientist")) { category = "portrait " + lowerSearchTerm; } else if (lowerSearchTerm.includes("fire") || lowerSearchTerm.includes("water") || lowerSearchTerm.includes("sand") || lowerSearchTerm.includes("element")) { category = "nature element " + lowerSearchTerm; } else if (lowerSearchTerm.includes("galaxy") || lowerSearchTerm.includes("universe") || lowerSearchTerm.includes("planet") || lowerSearchTerm.includes("star")) { category = "space " + lowerSearchTerm; } else if (lowerSearchTerm.includes("cartoon") || lowerSearchTerm.includes("movie character") || lowerSearchTerm.includes("superhero")) { category = "character art " + lowerSearchTerm; } else if (lowerSearchTerm.includes("car") || lowerSearchTerm.includes("house") || lowerSearchTerm.includes("non living")) { category = "object " + lowerSearchTerm; }
                return `https://source.unsplash.com/220x220/?${encodeURIComponent(category)}`;
            }
            const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX_ID}&q=${encodeURIComponent(searchTerm)}&searchType=image&num=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error(`Google API error! status: ${response.status}`); }
                const data = await response.json();
                if (data.items && data.items.length > 0) { return data.items[0].link; } else { console.warn("‚ö†Ô∏è No image found from Google for:", searchTerm); return defaultPlaceholder; }
            } catch (error) { console.error("üî¥ Error fetching image from Google API:", error); return defaultPlaceholder; }
        }

        async function processInput(t){askButton.disabled=!0,micButton.disabled=!0,showLoadingIndicator(),chatInput.value="",await callBackendAPI(t)}
        async function callBackendAPI(t){try{const e=await fetch("/ask",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();await renderVisualOutput(n),n.spoken_text&&"open_camera"!==n.type&&speakText(n.spoken_text,"animation_command"!==n.type&&"change_background"!==n.type)}catch(t){console.error(t); const e={spoken_text:"Oh no, my brain circuits are tangled!"};createTopTextContainer(),speakText(e.spoken_text,!0)}}
        function speakText(t,e){speechSynthesis.cancel();const n=new SpeechSynthesisUtterance(t),o=document.getElementById("top-text-container");if(o&&e){o.innerHTML="";const i=t.split(/\s+/),s=[];i.forEach(t=>{const e=document.createElement("span");e.className="caption-word",e.textContent=t,o.appendChild(e),s.push(e)});let l=0;n.onboundary=t=>{"word"===t.name&&l<s.length&&(s[l].classList.add("visible"),l++)}}
        e&&(n.onstart=()=>playAnimation("talk")),n.onend=()=>{if("talk"===currentAnimation&&playAnimation("idle"),askButton.disabled=!1,micButton.disabled=!1,o&&!document.getElementById("timer-widget")){o.querySelectorAll(".caption-word").forEach(t=>t.classList.add("visible"));
        // MODIFICATION 3: Call `clearOverlays` after text finishes
        setTimeout(clearOverlays, 4e3)}},speechSynthesis.speak(n)}
        
        let timerInterval,timeRemainingInSeconds,isTimerPaused=!0,initialSeconds=0;
        function createTimerWidget(seconds){initialSeconds=seconds,timeRemainingInSeconds=seconds;if(isNaN(timeRemainingInSeconds)){console.error("Timer started with invalid seconds value:",seconds);timeRemainingInSeconds=0}const t=document.createElement("div");t.id="timer-widget",t.innerHTML=`\n                <div id="timer-display"></div>\n                <div id="timer-controls">\n                    <button id="timer-start-pause" class="timer-btn start">Start</button>\n                    <button id="timer-reset" class="timer-btn reset">Reset</button>\n                    <button id="timer-edit" class="timer-btn edit">Edit</button>\n                </div>\n            `,visualOutputContainer.appendChild(t),updateTimerDisplay(),document.getElementById("timer-start-pause").onclick=toggleTimer,document.getElementById("timer-reset").onclick=resetTimer,document.getElementById("timer-edit").onclick=editTimer}
        function updateTimerDisplay(){const t=document.getElementById("timer-display");if(t){const e=Math.floor(timeRemainingInSeconds/60),n=timeRemainingInSeconds%60;t.textContent=`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`}}
        function toggleTimer(){if(isTimerPaused=!isTimerPaused,timeRemainingInSeconds<=0)return;const t=document.getElementById("timer-start-pause");isTimerPaused?(t.textContent="Start",t.className="timer-btn start",clearInterval(timerInterval)):(t.textContent="Pause",t.className="timer-btn pause",timerInterval=setInterval(tick,1e3))}
        function tick(){--timeRemainingInSeconds,updateTimerDisplay(),timeRemainingInSeconds<0&&(timeRemainingInSeconds=0),0===timeRemainingInSeconds&&(clearInterval(timerInterval),document.getElementById("timer-alarm").play(),setTimeout(()=>{clearOverlays(),speakText("Time's up! Your timer has finished.",!0)},4e3))}
        function resetTimer(){clearInterval(timerInterval),isTimerPaused=!0,createTimerWidget(initialSeconds)}
        function editTimer(){clearInterval(timerInterval),isTimerPaused=!0;const t=prompt(`Enter new time (e.g., '5m' for minutes or '30s' for seconds):`,`${Math.floor(initialSeconds/60)}m`);if(t){let e=0;t.toLowerCase().includes("m")?e=60*parseInt(t,10):t.toLowerCase().includes("s")?e=parseInt(t,10):!isNaN(parseInt(t,10))&&(e=60*parseInt(t,10)),e&&!isNaN(e)&&e>0?createTimerWidget(e):createTimerWidget(initialSeconds)}else createTimerWidget(initialSeconds)}
        
        // MODIFICATION 4: Make the stop button perform a full reset
        stopButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearTimeout(animationTimeout),clearInterval(timerInterval),playAnimation("idle"),resetSceneAndVisuals(),askButton.disabled=!1,micButton.disabled=!1});

        const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;if(SpeechRecognition){const t=new SpeechRecognition;t.continuous=!1,t.lang="en-US",t.interimResults=!1,micButton.addEventListener("click",()=>{speechSynthesis.cancel(),clearOverlays(),chatInput.value="",t.start()}),t.onstart=()=>micButton.classList.add("listening"),t.onend=()=>micButton.classList.remove("listening"),t.onresult=e=>{const n=e.results[e.results.length-1][0].transcript.trim();chatInput.value=n,processInput(n)}}else micButton.style.display="none";
        askButton.addEventListener("click",()=>{const t=chatInput.value;t&&(speechSynthesis.cancel(),clearOverlays(),processInput(t))}),chatInput.addEventListener("keyup",t=>{t.key==="Enter"&&askButton.click()});

        window.addEventListener('mousemove', (event) => {
            const normalizedX = (event.clientX / window.innerWidth) * 2 - 1;
            targetRotationY = normalizedX * 0.5;
        });
        
        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getDelta();
            mixer && mixer.update(t);
            if (character) {
                character.rotation.y += (targetRotationY - character.rotation.y) * 0.05;
            }
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight) });

        // --- 3. TRIVIA GAME LOGIC ---
        const triviaModalOverlay = document.getElementById('trivia-modal-overlay');
        const topicSelectionView = document.getElementById('topic-selection');
        const gameView = document.getElementById('game-view');
        const topicTitleEl = document.getElementById('topic-title');
        const scoreEl = document.getElementById('score');
        const loaderContainer = document.getElementById('loader-container');
        const qaContainer = document.getElementById('qa-container');
        const questionTextEl = document.getElementById('question-text');
        const answersGridEl = document.getElementById('answers-grid');
        const funFactTextEl = document.getElementById('fun-fact-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        let currentTopic = '';
        let score = 0;
        let currentCorrectAnswer = '';
        let currentTopicQuestions = [];
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        window.goHome = function() {
            triviaModalOverlay.classList.remove('visible');
            setTimeout(() => {
                triviaModalOverlay.classList.add('hidden');
                triviaModalOverlay.classList.add('pointer-events-none');
                gameView.classList.add('hidden');
                topicSelectionView.classList.remove('hidden');
            }, 300);
        }
        window.goBackToTopics = function() {
            gameView.classList.add('hidden');
            topicSelectionView.classList.remove('hidden');
            topicSelectionView.classList.add('animate-fadeInUp');
        }
        window.startGame = function(topic) {
            currentTopic = topic;
            score = 0;
            scoreEl.textContent = score;
            topicTitleEl.textContent = topic;
            const questionsForTopic = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
            shuffleArray(questionsForTopic);
            currentTopicQuestions = questionsForTopic;
            topicSelectionView.classList.add('hidden');
            gameView.classList.remove('hidden');
            gameView.classList.add('animate-fadeInUp');
            fetchNewQuestion();
        }
        function fetchNewQuestion() {
            qaContainer.classList.add('hidden');
            loaderContainer.classList.remove('hidden');
            funFactTextEl.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            answersGridEl.innerHTML = '';
            setTimeout(() => {
                const backupData = getBackupQuestion(currentTopic);
                if (backupData) {
                    displayQuestion(backupData);
                } else {
                    questionTextEl.textContent = "You're a trivia master! Let's start this topic over.";
                    answersGridEl.innerHTML = '';
                    setTimeout(fetchNewQuestion, 2000);
                }
            }, 600);
        }
        function getBackupQuestion(topic) {
            if (currentTopicQuestions.length === 0) {
                console.log("Reshuffling questions for topic:", topic);
                const originalQuestions = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
                shuffleArray(originalQuestions);
                currentTopicQuestions = originalQuestions;
            }
            return currentTopicQuestions.pop();
        }
        function displayQuestion(data) {
            questionTextEl.textContent = data.question;
            currentCorrectAnswer = data.correct_answer;
            qaContainer.classList.remove('animate-fadeInUp');
            void qaContainer.offsetWidth;
            qaContainer.classList.add('animate-fadeInUp');
            data.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'answer-btn w-full p-4 bg-gray-700 rounded-lg text-lg font-semibold';
                button.onclick = () => checkAnswer(button, option, data.fun_fact);
                answersGridEl.appendChild(button);
            });
            loaderContainer.classList.add('hidden');
            qaContainer.classList.remove('hidden');
        }
        function checkAnswer(buttonEl, selectedOption, funFact) {
            const answerButtons = answersGridEl.querySelectorAll('.answer-btn');
            answerButtons.forEach(btn => btn.disabled = true);
            const animationClass = selectedOption === currentCorrectAnswer ? 'animate-pulseCorrect' : 'animate-shakeIncorrect';
            buttonEl.classList.add(animationClass);
            buttonEl.addEventListener('animationend', () => buttonEl.classList.remove(animationClass), { once: true });
            
            if (selectedOption === currentCorrectAnswer) {
                score++;
                scoreEl.textContent = score;
                buttonEl.classList.add('correct');
            } else {
                buttonEl.classList.add('incorrect');
                answerButtons.forEach(btn => {
                    if (btn.textContent === currentCorrectAnswer) btn.classList.add('correct');
                });
            }
            funFactTextEl.textContent = `üí° Fun Fact: ${funFact}`;
            nextQuestionBtn.classList.remove('hidden');
        }
        nextQuestionBtn.addEventListener('click', fetchNewQuestion);
        const backupQuestions = {
            'General Knowledge': [{ "question": "What is the capital of France?", "options": ["London", "Berlin", "Paris", "Madrid"], "correct_answer": "Paris", "fun_fact": "Paris is often called the 'City of Light' (La Ville Lumi√®re)." }, { "question": "How many colors are in a rainbow?", "options": ["5", "7", "8", "6"], "correct_answer": "7", "fun_fact": "The colors are Red, Orange, Yellow, Green, Blue, Indigo, and Violet." }, { "question": "Which is the largest ocean on Earth?", "options": ["Atlantic", "Indian", "Arctic", "Pacific"], "correct_answer": "Pacific", "fun_fact": "The Pacific Ocean covers about 30% of the Earth's surface." }],
            'Science Fun': [{ "question": "What planet is known as the Red Planet?", "options": ["Earth", "Mars", "Jupiter", "Saturn"], "correct_answer": "Mars", "fun_fact": "Mars has two small moons, Phobos and Deimos." }, { "question": "What force pulls objects towards the Earth?", "options": ["Magnetism", "Friction", "Gravity", "Inertia"], "correct_answer": "Gravity", "fun_fact": "Gravity is what gives weight to objects." }, { "question": "What do plants use to make their own food?", "options": ["Photosynthesis", "Respiration", "Digestion", "Evaporation"], "correct_answer": "Photosynthesis", "fun_fact": "During photosynthesis, plants release oxygen, which we need to breathe." }],
            'History & Myths': [{ "question": "Who was the first person to walk on the moon?", "options": ["Buzz Aldrin", "Yuri Gagarin", "Michael Collins", "Neil Armstrong"], "correct_answer": "Neil Armstrong", "fun_fact": "His famous words were, 'That's one small step for man, one giant leap for mankind.'" }, { "question": "In Greek mythology, who is the king of the gods?", "options": ["Hades", "Poseidon", "Zeus", "Apollo"], "correct_answer": "Zeus", "fun_fact": "Zeus's Roman equivalent is Jupiter." }],
            'World Explorer': [{ "question": "Which is the longest river in the world?", "options": ["Amazon", "Nile", "Yangtze", "Mississippi"], "correct_answer": "Nile", "fun_fact": "The Nile River flows through 11 countries in Africa." }, { "question": "What is the name of the tallest mountain in the world?", "options": ["K2", "Kangchenjunga", "Mount Everest", "Lhotse"], "correct_answer": "Mount Everest", "fun_fact": "Mount Everest is located in the Himalayas on the border of Nepal and China." }],
            'Math & Logic': [{ "question": "How many sides does a triangle have?", "options": ["3", "4", "5", "6"], "correct_answer": "3", "fun_fact": "The sum of the angles in a triangle is always 180 degrees." }, { "question": "What is 15 + 25?", "options": ["30", "35", "40", "45"], "correct_answer": "40", "fun_fact": "Addition is one of the four basic operations of arithmetic." }],
            'Aptitude Puzzles': [{ "question": "Which number comes next in the series: 2, 4, 6, 8, ...?", "options": ["9", "10", "12", "11"], "correct_answer": "10", "fun_fact": "This is a simple series of even numbers, increasing by 2 each time." }, { "question": "If a train travels 60 miles in 1 hour, how many miles does it travel in 30 minutes?", "options": ["15", "30", "45", "60"], "correct_answer": "30", "fun_fact": "30 minutes is half an hour, so the train would travel half the distance." }]
        };

        // --- 4. CAMERA MODAL LOGIC ---
        const cameraModalOverlay = document.getElementById('camera-modal-overlay');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const videoFeed = document.getElementById('video-feed');
        const mainCanvas = document.getElementById('main-canvas');
        const photoCanvas = document.getElementById('photo-canvas');
        const cameraTimerDisplay = document.getElementById('camera-timer-display');
        const takePhotoButton = document.getElementById('take-photo-button');
        const saveButton = document.getElementById('save-button');
        const retakeButton = document.getElementById('retake-button');
        const saveModal = document.getElementById('save-modal');
        const filenameInput = document.getElementById('filename-input');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const cameraView = document.getElementById('camera-view');
        const editingView = document.getElementById('editing-view');
        const flashOverlay = document.getElementById('flash-overlay');
        const sizeControlContainer = document.getElementById('size-control-container');
        const sizeSlider = document.getElementById('size-slider');
        let stream, currentFilter="none", capturedImage, ctx=mainCanvas.getContext("2d");
        let selectedObject = null, isDragging = false, dragStart = {x:0, y:0}, objectStart = {x:0, y:0};
        function openCameraModal(){return new Promise((t,e)=>{cameraModalOverlay.classList.remove("hidden"),setTimeout(()=>cameraModalOverlay.classList.add("visible"),10),startCamera();const n=()=>{saveModal.classList.remove("hidden")},o=()=>{let o=filenameInput.value.trim()||"avatar-photo",i=mainCanvas.toDataURL("image/jpeg");s(),r(),t({imageDataUrl:i,filename:o})},i=()=>{saveModal.classList.add("hidden")},s=()=>{cameraModalOverlay.classList.remove("visible"),setTimeout(()=>cameraModalOverlay.classList.add("hidden"),500),stopCamera(),retakeButton.click()},r=()=>{saveButton.removeEventListener("click",n),modalSaveBtn.removeEventListener("click",o),modalCancelBtn.removeEventListener("click",i),closeCameraBtn.removeEventListener("click",a)},a=()=>{s(),r(),e("Camera closed by user")};saveButton.addEventListener("click",n),modalSaveBtn.addEventListener("click",o),modalCancelBtn.addEventListener("click",i),closeCameraBtn.addEventListener("click",a)})}
        function displayCapturedPhoto(imageDataUrl){const t=document.getElementById("captured-photo-container");t&&t.remove();const e=document.createElement("div");e.id="captured-photo-container";const n=document.createElement("img");n.src=imageDataUrl,e.appendChild(n),visualOutputContainer.appendChild(e),setTimeout(()=>e.classList.add("visible"),100)}
        function triggerAutoDownload(t,e){const n=document.createElement("a");n.href=t,n.download=`${e}.jpeg`,n.click()}
        async function startCamera(){try{stream=await navigator.mediaDevices.getUserMedia({video:!0}),videoFeed.srcObject=stream,await videoFeed.play(),cameraView.classList.remove("hidden"),editingView.classList.add("hidden"),editingView.classList.remove("flex"),takePhotoButton.classList.remove("hidden")}catch(t){console.error("Error accessing camera: ",t)}}
        function stopCamera(){stream&&stream.getTracks().forEach(t=>t.stop())}
        function startTimer(){let t=3;cameraTimerDisplay.textContent=t,cameraTimerDisplay.classList.remove("hidden"),takePhotoButton.classList.add("hidden");const e=setInterval(()=>{t--,cameraTimerDisplay.textContent=t,0===t&&(clearInterval(e),cameraTimerDisplay.classList.add("hidden"),capturePhoto())},1e3)}
        function capturePhoto(){photoCanvas.width=videoFeed.videoWidth,photoCanvas.height=videoFeed.videoHeight;const t=photoCanvas.getContext("2d");t.drawImage(videoFeed,0,0,photoCanvas.width,photoCanvas.height),capturedImage=new Image,capturedImage.src=photoCanvas.toDataURL("image/jpeg"),capturedImage.onload=()=>{mainCanvas.width=capturedImage.width,mainCanvas.height=capturedImage.height,ctx.drawImage(capturedImage,0,0),cameraView.classList.add("hidden"),editingView.classList.remove("hidden"),editingView.classList.add("flex"),stopCamera(),flashEffect()}}
        function flashEffect(){flashOverlay.style.width=`${mainCanvas.offsetWidth}px`,flashOverlay.style.height=`${mainCanvas.offsetHeight}px`,flashOverlay.style.left=`${mainCanvas.offsetLeft}px`,flashOverlay.style.top=`${mainCanvas.offsetTop}px`,flashOverlay.classList.remove("hidden"),flashOverlay.classList.add("flash"),setTimeout(()=>{flashOverlay.classList.add("hidden"),flashOverlay.classList.remove("flash")},500)}
        function redrawCanvas(){ctx.clearRect(0,0,mainCanvas.width,mainCanvas.height),ctx.filter=currentFilter,ctx.drawImage(capturedImage,0,0,mainCanvas.width,mainCanvas.height),ctx.filter="none";if(selectedObject){const{type:t,value:e,size:n,position:o}=selectedObject;"emoji"===t&&(ctx.font=`${n}px serif`,ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(e,o.x,o.y))}}
        document.querySelectorAll(".filter-button").forEach(t=>{t.addEventListener("click",()=>{switch(t.dataset.filter){case"none":currentFilter="none";break;case"grayscale":currentFilter="grayscale(1)";break;case"sepia":currentFilter="sepia(1)";break;case"invert":currentFilter="invert(1)";break;case"saturate":currentFilter="saturate(200%)";break;case"contrast":currentFilter="contrast(200%)";break;case"brightness":currentFilter="brightness(150%)";break;case"blur":currentFilter="blur(5px)";break}redrawCanvas()})});
        function selectObject(t,e){selectedObject={type:t,value:e,size:parseInt(sizeSlider.value),position:{x:mainCanvas.width/2,y:mainCanvas.height/2}},sizeControlContainer.classList.remove("hidden"),redrawCanvas()}
        document.querySelectorAll(".emoji-button").forEach(t=>t.addEventListener("click",()=>selectObject("emoji",t.dataset.emoji))),sizeSlider.addEventListener("input",t=>{selectedObject&&(selectedObject.size=parseInt(t.target.value),redrawCanvas())});
        mainCanvas.addEventListener('mousedown', e => { if (selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; const { position, size } = selectedObject; if (mouseX > position.x - size / 2 && mouseX < position.x + size / 2 && mouseY > position.y - size / 2 && mouseY < position.y + size / 2) { isDragging = true; mainCanvas.style.cursor = 'grabbing'; dragStart.x = mouseX; dragStart.y = mouseY; objectStart.x = position.x; objectStart.y = position.y; } } });
        mainCanvas.addEventListener('mousemove', e => { if (isDragging && selectedObject) { const rect = mainCanvas.getBoundingClientRect(), scaleX = mainCanvas.width / rect.width, scaleY = mainCanvas.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY; selectedObject.position.x = objectStart.x + (mouseX - dragStart.x); selectedObject.position.y = objectStart.y + (mouseY - dragStart.y); redrawCanvas(); } });
        mainCanvas.addEventListener('mouseup', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        mainCanvas.addEventListener('mouseleave', () => { isDragging = false; mainCanvas.style.cursor = 'grab'; });
        closeCameraBtn.addEventListener('click', ()=>{const e=document.createEvent("Event");e.initEvent("manualclose",!0,!0),closeCameraBtn.dispatchEvent(e)});
        takePhotoButton.addEventListener('click', startTimer);
        retakeButton.addEventListener("click",()=>{currentFilter="none",selectedObject=null,sizeControlContainer.classList.add("hidden"),sizeSlider.value=96,startCamera()});
        saveButton.addEventListener('click',()=>saveModal.classList.remove("hidden"));
        modalCancelBtn.addEventListener('click',()=>saveModal.classList.add("hidden"));
        modalSaveBtn.addEventListener("click",()=>{const t=document.createEvent("Event");t.initEvent("manualsave",!0,!0),modalSaveBtn.dispatchEvent(t)});

    </script>
</body>
</html> -->







<!-- main.js -->






import * as THREE from 'three';
import {
    OrbitControls
} from 'three/addons/controls/OrbitControls.js';
import {
    GLTFLoader
} from 'three/addons/loaders/GLTFLoader.js';

// --- 1. AI AVATAR LOGIC ---
const GOOGLE_API_KEY = "AIzaSyB-KJmyjTJ4mKvLQXJFXW1WfyTi_D-nF2I"; // Replace if you have one
const GOOGLE_CX_ID = "83c4d23e4411a429b"; // Replace if you have one

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf0f2f5);
const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(0, 1.5, 5);
const renderer = new THREE.WebGLRenderer({
    antialias: true
});
document.getElementById('container').appendChild(renderer.domElement);
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;

const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
directionalLight.position.set(5, 10, 7.5);
directionalLight.castShadow = true;
scene.add(directionalLight);

const ground = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshStandardMaterial({
    color: 0xcccccc
}));
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 1, 0);
controls.update();

let mixer, character;
const animations = new Map();
const clock = new THREE.Clock();
const gltfLoader = new GLTFLoader();
const textureLoader = new THREE.TextureLoader();

const chatInput = document.getElementById('chat-input');
const askButton = document.getElementById('ask-btn');
const micButton = document.getElementById('mic-btn');
const stopButton = document.getElementById('stop-btn');

const CHARACTER_MODEL_PATH = '/static/character.glb';
const IDLE_ANIM_NAME = 'idle',
    TALKING_ANIM_NAME = 'talk';

gltfLoader.load(CHARACTER_MODEL_PATH, (gltf) => {
    character = gltf.scene;
    scene.add(character);
    mixer = new THREE.AnimationMixer(character);
    gltf.animations.forEach((clip) => {
        const clipName = clip.name.toLowerCase() === 'jum' ? 'jump' : clip.name.toLowerCase();
        animations.set(clipName, mixer.clipAction(clip))
    });
    if (animations.has(IDLE_ANIM_NAME)) playAnimation(IDLE_ANIM_NAME)
});

let currentAnimation = null;
let animationTimeout;
let targetRotationY = 0;

function playAnimation(name, duration = null) {
    const animName = name.toLowerCase();
    if (!animations.has(animName)) return;

    clearTimeout(animationTimeout);

    const isLooping = ["idle", "talk"].includes(animName) || duration;
    const action = animations.get(animName);
    action.timeScale = ["dance", "jump", "walk"].includes(animName) ? 0.5 : 1;

    const currentAction = currentAnimation ? animations.get(currentAnimation) : null;
    if (currentAction) currentAction.fadeOut(0.3);

    action.reset().setEffectiveWeight(1).fadeIn(0.3).play();
    action.loop = isLooping ? THREE.LoopRepeat : THREE.LoopOnce;
    action.clampWhenFinished = !isLooping;
    currentAnimation = animName;

    if (duration) {
        animationTimeout = setTimeout(() => playAnimation("idle"), duration);
    } else if (!isLooping) {
        mixer.addEventListener("finished", function onFinished() {
            playAnimation("idle");
            mixer.removeEventListener("finished", onFinished);
        });
    }
}

const visualOutputContainer = document.getElementById("visual-output-container");

function openTriviaModal() {
    const triviaModal = document.getElementById('trivia-modal-overlay');
    if (triviaModal) {
        triviaModal.classList.remove('hidden', 'pointer-events-none');
        setTimeout(() => {
            triviaModal.classList.add('visible', 'animate-fadeInUp');
        }, 10);
    }
}

async function renderVisualOutput(data) {
    // Override for trivia keyword
    if (data.spoken_text && data.spoken_text.toLowerCase().includes('trivia')) {
        data.type = 'start_trivia_game';
        data.spoken_text = "Great! Let's play some trivia. The game has appeared on your screen.";
    }

    if (data.type !== 'start_trivia_game') {
        clearOverlays();
    }

    switch (data.type) {
        case "reset_view":
            resetSceneAndVisuals();
            break;
        case "set_timer":
            createTimerWidget(data.seconds);
            break;
        case "open_camera":
            handlePhotoCapture(data.intent || 'save');
            break;
        case "describe_object": // ‚ú® NEW: Handle AI Vision command
            handlePhotoCapture('describe');
            break;
        case "start_trivia_game":
            openTriviaModal();
            break;
        case "animation_command":
            playAnimation(data.animation_name, 5000);
            break;
        case "sing_song":
            createTopTextContainer();
            break;
        case "math_sequence":
            renderMathSequence(data.elements);
            break;
        case "image_topic":
            renderImage(await fetchGoogleImage(data.search_term));
            break;
        case "comparison_topic":
            createTopTextContainer();
            renderComparisonImages(data.entities);
            break;
        case "change_background":
            if (data.image_url) {
                changeSceneBackground(data.image_url);
            }
            createTopTextContainer();
            break;
        case "simple_text":
        default:
            createTopTextContainer();
    }
}

function changeSceneBackground(imageUrl) {
    const topText = document.getElementById("top-text-container") || createTopTextContainer();
    topText.textContent = "Traveling...";

    textureLoader.load(imageUrl,
        (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.background = texture;
            scene.environment = texture;
            ground.visible = false;
            topText.textContent = "";
        },
        undefined,
        (err) => {
            console.error('Error loading background texture:', err);
            speakText("I had some trouble loading that scene. Let's stay here for now.", true);
            scene.background = new THREE.Color(0xf0f2f5);
            ground.visible = true;
        }
    );
}

function createTopTextContainer() {
    const container = document.createElement("div");
    container.id = "top-text-container";
    visualOutputContainer.appendChild(container);
    return container;
}

async function renderComparisonImages(entities) {
    const imagePromises = entities.map(entity => fetchGoogleImage(entity.search_term));
    const imageUrls = await Promise.all(imagePromises);

    const leftContainer = document.createElement("div");
    leftContainer.className = "comparison-image-container left";
    const leftImg = document.createElement("img");
    leftImg.src = imageUrls[0];
    leftContainer.appendChild(leftImg);
    visualOutputContainer.appendChild(leftContainer);

    if (imageUrls.length > 1) {
        const rightContainer = document.createElement("div");
        rightContainer.className = "comparison-image-container right";
        const rightImg = document.createElement("img");
        rightImg.src = imageUrls[1];
        rightContainer.appendChild(rightImg);
        visualOutputContainer.appendChild(rightContainer);
    }

    setTimeout(() => {
        leftContainer.classList.add("visible");
        visualOutputContainer.querySelector(".right")?.classList.add("visible");
    }, 50);
}

async function renderMathSequence(elements) {
    const container = document.createElement("div");
    container.className = "math-container";
    visualOutputContainer.appendChild(container);

    for (const el of elements) {
        const span = document.createElement("span");
        span.className = "math-element";
        span.textContent = el;
        container.appendChild(span);
        await new Promise(res => setTimeout(res, 50));
        span.classList.add("visible");
        await new Promise(res => setTimeout(res, 600));
    }
}

function renderImage(imageUrl) {
    const container = document.createElement("div");
    container.className = "image-topic-container";
    const imgElement = document.createElement("img");
    imgElement.src = imageUrl;
    container.appendChild(imgElement);
    visualOutputContainer.appendChild(container);
    setTimeout(() => container.classList.add("visible"), 100);
    createTopTextContainer();
}

function showLoadingIndicator() {
    clearOverlays();
    const topText = createTopTextContainer();
    topText.textContent = "Thinking... ü§î";
}

function clearOverlays() {
    visualOutputContainer.innerHTML = "";
}

function resetSceneAndVisuals() {
    clearOverlays();
    if (scene.background && scene.background.isTexture) {
        scene.background = new THREE.Color(0xf0f2f5);
        scene.environment = null;
        ground.visible = true;
    }
}

async function fetchGoogleImage(searchTerm) {
    const defaultPlaceholder = "https://picsum.photos/220/220?grayscale";
    if (!GOOGLE_API_KEY || !GOOGLE_CX_ID || GOOGLE_API_KEY.includes('YOUR_')) {
        return `https://source.unsplash.com/220x220/?${encodeURIComponent(searchTerm)}`;
    }
    const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${GOOGLE_CX_ID}&q=${encodeURIComponent(searchTerm)}&searchType=image&num=1`;
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Google API error! status: ${response.status}`);
        const data = await response.json();
        return (data.items && data.items.length > 0) ? data.items[0].link : defaultPlaceholder;
    } catch (error) {
        console.error("üî¥ Error fetching image from Google API:", error);
        return defaultPlaceholder;
    }
}

async function processInput(prompt) {
    askButton.disabled = true;
    micButton.disabled = true;
    showLoadingIndicator();
    chatInput.value = "";
    await callBackendAPI(prompt);
}

async function callBackendAPI(prompt) {
    try {
        const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt }),
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        await renderVisualOutput(data);
        if (data.spoken_text && data.type !== "open_camera" && data.type !== "describe_object") {
            speakText(data.spoken_text, data.type !== "animation_command" && data.type !== "change_background");
        }
    } catch (error) {
        console.error(error);
        createTopTextContainer();
        speakText("Oh no, my brain circuits are tangled!", true);
    }
}

function speakText(text, showCaptions) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    const topText = document.getElementById("top-text-container");

    if (topText && showCaptions) {
        topText.innerHTML = "";
        const words = text.split(/\s+/);
        const wordElements = [];
        words.forEach(word => {
            const span = document.createElement("span");
            span.className = "caption-word";
            span.textContent = word;
            topText.appendChild(span);
            wordElements.push(span);
        });

        let wordIndex = 0;
        utterance.onboundary = event => {
            if (event.name === "word" && wordIndex < wordElements.length) {
                wordElements[wordIndex].classList.add("visible");
                wordIndex++;
            }
        };
    }

    if (showCaptions) {
        utterance.onstart = () => playAnimation("talk");
    }

    utterance.onend = () => {
        if (currentAnimation === "talk") playAnimation("idle");
        askButton.disabled = false;
        micButton.disabled = false;
        if (topText && !document.getElementById("timer-widget")) {
            topText.querySelectorAll(".caption-word").forEach(span => span.classList.add("visible"));
            setTimeout(clearOverlays, 4000);
        }
    };

    speechSynthesis.speak(utterance);
}


let timerInterval, timeRemainingInSeconds, isTimerPaused = true,
    initialSeconds = 0;

function createTimerWidget(seconds) {
    initialSeconds = seconds;
    timeRemainingInSeconds = seconds;
    if (isNaN(timeRemainingInSeconds)) timeRemainingInSeconds = 0;

    const widget = document.createElement("div");
    widget.id = "timer-widget";
    widget.innerHTML = `
        <div id="timer-display"></div>
        <div id="timer-controls">
            <button id="timer-start-pause" class="timer-btn start">Start</button>
            <button id="timer-reset" class="timer-btn reset">Reset</button>
            <button id="timer-edit" class="timer-btn edit">Edit</button>
        </div>`;
    visualOutputContainer.appendChild(widget);
    updateTimerDisplay();
    document.getElementById("timer-start-pause").onclick = toggleTimer;
    document.getElementById("timer-reset").onclick = resetTimer;
    document.getElementById("timer-edit").onclick = editTimer;
}

function updateTimerDisplay() {
    const display = document.getElementById("timer-display");
    if (display) {
        const minutes = Math.floor(timeRemainingInSeconds / 60);
        const seconds = timeRemainingInSeconds % 60;
        display.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }
}

function toggleTimer() {
    isTimerPaused = !isTimerPaused;
    if (timeRemainingInSeconds <= 0) return;
    const button = document.getElementById("timer-start-pause");
    if (isTimerPaused) {
        button.textContent = "Start";
        button.className = "timer-btn start";
        clearInterval(timerInterval);
    } else {
        button.textContent = "Pause";
        button.className = "timer-btn pause";
        timerInterval = setInterval(tick, 1000);
    }
}

function tick() {
    timeRemainingInSeconds--;
    updateTimerDisplay();
    if (timeRemainingInSeconds < 0) timeRemainingInSeconds = 0;
    if (timeRemainingInSeconds === 0) {
        clearInterval(timerInterval);
        document.getElementById("timer-alarm").play();
        setTimeout(() => {
            clearOverlays();
            speakText("Time's up! Your timer has finished.", true);
        }, 4000);
    }
}

function resetTimer() {
    clearInterval(timerInterval);
    isTimerPaused = true;
    createTimerWidget(initialSeconds);
}

function editTimer() {
    clearInterval(timerInterval);
    isTimerPaused = true;
    const newTime = prompt(`Enter new time (e.g., '5m' for minutes or '30s' for seconds):`, `${Math.floor(initialSeconds / 60)}m`);
    if (newTime) {
        let seconds = 0;
        if (newTime.toLowerCase().includes("m")) {
            seconds = parseInt(newTime, 10) * 60;
        } else if (newTime.toLowerCase().includes("s")) {
            seconds = parseInt(newTime, 10);
        } else if (!isNaN(parseInt(newTime, 10))) {
            seconds = parseInt(newTime, 10) * 60;
        }
        createTimerWidget(seconds > 0 ? seconds : initialSeconds);
    } else {
        createTimerWidget(initialSeconds);
    }
}

stopButton.addEventListener("click", () => {
    speechSynthesis.cancel();
    clearTimeout(animationTimeout);
    clearInterval(timerInterval);
    playAnimation("idle");
    resetSceneAndVisuals();
    askButton.disabled = false;
    micButton.disabled = false;
});

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = "en-US";
    recognition.interimResults = false;
    micButton.addEventListener("click", () => {
        speechSynthesis.cancel();
        clearOverlays();
        chatInput.value = "";
        recognition.start();
    });
    recognition.onstart = () => micButton.classList.add("listening");
    recognition.onend = () => micButton.classList.remove("listening");
    recognition.onresult = event => {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        chatInput.value = transcript;
        processInput(transcript);
    };
} else {
    micButton.style.display = "none";
}

askButton.addEventListener("click", () => {
    const prompt = chatInput.value;
    if (prompt) {
        speechSynthesis.cancel();
        clearOverlays();
        processInput(prompt);
    }
});
chatInput.addEventListener("keyup", event => {
    if (event.key === "Enter") askButton.click();
});

window.addEventListener('mousemove', (event) => {
    const normalizedX = (event.clientX / window.innerWidth) * 2 - 1;
    targetRotationY = normalizedX * 0.5;
});

function animate() {
    requestAnimationFrame(animate);
    const delta = clock.getDelta();
    if (mixer) mixer.update(delta);
    if (character) {
        character.rotation.y += (targetRotationY - character.rotation.y) * 0.05;
    }
    renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});


// --- 3. TRIVIA GAME LOGIC ---
// (This section remains unchanged from your provided code)
const triviaModalOverlay = document.getElementById('trivia-modal-overlay');
const topicSelectionView = document.getElementById('topic-selection');
const gameView = document.getElementById('game-view');
const topicTitleEl = document.getElementById('topic-title');
const scoreEl = document.getElementById('score');
const loaderContainer = document.getElementById('loader-container');
const qaContainer = document.getElementById('qa-container');
const questionTextEl = document.getElementById('question-text');
const answersGridEl = document.getElementById('answers-grid');
const funFactTextEl = document.getElementById('fun-fact-text');
const nextQuestionBtn = document.getElementById('next-question-btn');
let currentTopic = '';
let score = 0;
let currentCorrectAnswer = '';
let currentTopicQuestions = [];
function shuffleArray(array) {
¬† ¬† for (let i = array.length - 1; i > 0; i--) {
¬† ¬† ¬† ¬† const j = Math.floor(Math.random() * (i + 1));
¬† ¬† ¬† ¬† [array[i], array[j]] = [array[j], array[i]];
¬† ¬† }
}
window.goHome = function() {
¬† ¬† triviaModalOverlay.classList.remove('visible');
¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† triviaModalOverlay.classList.add('hidden');
¬† ¬† ¬† ¬† triviaModalOverlay.classList.add('pointer-events-none');
¬† ¬† ¬† ¬† gameView.classList.add('hidden');
¬† ¬† ¬† ¬† topicSelectionView.classList.remove('hidden');
¬† ¬† }, 300);
}
window.goBackToTopics = function() {
¬† ¬† gameView.classList.add('hidden');
¬† ¬† topicSelectionView.classList.remove('hidden');
¬† ¬† topicSelectionView.classList.add('animate-fadeInUp');
}
window.startGame = function(topic) {
¬† ¬† currentTopic = topic;
¬† ¬† score = 0;
¬† ¬† scoreEl.textContent = score;
¬† ¬† topicTitleEl.textContent = topic;
¬† ¬† const questionsForTopic = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
¬† ¬† shuffleArray(questionsForTopic);
¬† ¬† currentTopicQuestions = questionsForTopic;
¬† ¬† topicSelectionView.classList.add('hidden');
¬† ¬† gameView.classList.remove('hidden');
¬† ¬† gameView.classList.add('animate-fadeInUp');
¬† ¬† fetchNewQuestion();
}
function fetchNewQuestion() {
¬† ¬† qaContainer.classList.add('hidden');
¬† ¬† loaderContainer.classList.remove('hidden');
¬† ¬† funFactTextEl.textContent = '';
¬† ¬† nextQuestionBtn.classList.add('hidden');
¬† ¬† answersGridEl.innerHTML = '';
¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† const backupData = getBackupQuestion(currentTopic);
¬† ¬† ¬† ¬† if (backupData) {
¬† ¬† ¬† ¬† ¬† ¬† displayQuestion(backupData);
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† questionTextEl.textContent = "You're a trivia master! Let's start this topic over.";
¬† ¬† ¬† ¬† ¬† ¬† answersGridEl.innerHTML = '';
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(fetchNewQuestion, 2000);
¬† ¬† ¬† ¬† }
¬† ¬† }, 600);
}
function getBackupQuestion(topic) {
¬† ¬† if (currentTopicQuestions.length === 0) {
¬† ¬† ¬† ¬† const originalQuestions = [...(backupQuestions[topic] || backupQuestions['General Knowledge'])];
¬† ¬† ¬† ¬† shuffleArray(originalQuestions);
¬† ¬† ¬† ¬† currentTopicQuestions = originalQuestions;
¬† ¬† }
¬† ¬† return currentTopicQuestions.pop();
}
function displayQuestion(data) {
¬† ¬† questionTextEl.textContent = data.question;
¬† ¬† currentCorrectAnswer = data.correct_answer;
¬† ¬† qaContainer.classList.remove('animate-fadeInUp');
¬† ¬† void qaContainer.offsetWidth;
¬† ¬† qaContainer.classList.add('animate-fadeInUp');
¬† ¬† data.options.forEach(option => {
¬† ¬† ¬† ¬† const button = document.createElement('button');
¬† ¬† ¬† ¬† button.textContent = option;
¬† ¬† ¬† ¬† button.className = 'answer-btn w-full p-4 bg-gray-700 rounded-lg text-lg font-semibold';
¬† ¬† ¬† ¬† button.onclick = () => checkAnswer(button, option, data.fun_fact);
¬† ¬† ¬† ¬† answersGridEl.appendChild(button);
¬† ¬† });
¬† ¬† loaderContainer.classList.add('hidden');
¬† ¬† qaContainer.classList.remove('hidden');
}
function checkAnswer(buttonEl, selectedOption, funFact) {
¬† ¬† const answerButtons = answersGridEl.querySelectorAll('.answer-btn');
¬† ¬† answerButtons.forEach(btn => btn.disabled = true);
¬† ¬† const animationClass = selectedOption === currentCorrectAnswer ? 'animate-pulseCorrect' : 'animate-shakeIncorrect';
¬† ¬† buttonEl.classList.add(animationClass);
¬† ¬† buttonEl.addEventListener('animationend', () => buttonEl.classList.remove(animationClass), { once: true });
¬† ¬† if (selectedOption === currentCorrectAnswer) {
¬† ¬† ¬† ¬† score++;
¬† ¬† ¬† ¬† scoreEl.textContent = score;
¬† ¬† ¬† ¬† buttonEl.classList.add('correct');
¬† ¬† } else {
¬† ¬† ¬† ¬† buttonEl.classList.add('incorrect');
¬† ¬† ¬† ¬† answerButtons.forEach(btn => {
¬† ¬† ¬† ¬† ¬† ¬† if (btn.textContent === currentCorrectAnswer) btn.classList.add('correct');
¬† ¬† ¬† ¬† });
¬† ¬† }
¬† ¬† funFactTextEl.textContent = `üí° Fun Fact: ${funFact}`;
¬† ¬† nextQuestionBtn.classList.remove('hidden');
}
nextQuestionBtn.addEventListener('click', fetchNewQuestion);
const backupQuestions = { 'General Knowledge': [{ "question": "What is the capital of France?", "options": ["London", "Berlin", "Paris", "Madrid"], "correct_answer": "Paris", "fun_fact": "Paris is often called the 'City of Light' (La Ville Lumi√®re)." }, { "question": "How many colors are in a rainbow?", "options": ["5", "7", "8", "6"], "correct_answer": "7", "fun_fact": "The colors are Red, Orange, Yellow, Green, Blue, Indigo, and Violet." }, { "question": "Which is the largest ocean on Earth?", "options": ["Atlantic", "Indian", "Arctic", "Pacific"], "correct_answer": "Pacific", "fun_fact": "The Pacific Ocean covers about 30% of the Earth's surface." }], 'Science Fun': [{ "question": "What planet is known as the Red Planet?", "options": ["Earth", "Mars", "Jupiter", "Saturn"], "correct_answer": "Mars", "fun_fact": "Mars has two small moons, Phobos and Deimos." }, { "question": "What force pulls objects towards the Earth?", "options": ["Magnetism", "Friction", "Gravity", "Inertia"], "correct_answer": "Gravity", "fun_fact": "Gravity is what gives weight to objects." }, { "question": "What do plants use to make their own food?", "options": ["Photosynthesis", "Respiration", "Digestion", "Evaporation"], "correct_answer": "Photosynthesis", "fun_fact": "During photosynthesis, plants release oxygen, which we need to breathe." }], 'History & Myths': [{ "question": "Who was the first person to walk on the moon?", "options": ["Buzz Aldrin", "Yuri Gagarin", "Michael Collins", "Neil Armstrong"], "correct_answer": "Neil Armstrong", "fun_fact": "His famous words were, 'That's one small step for man, one giant leap for mankind.'" }, { "question": "In Greek mythology, who is the king of the gods?", "options": ["Hades", "Poseidon", "Zeus", "Apollo"], "correct_answer": "Zeus", "fun_fact": "Zeus's Roman equivalent is Jupiter." }], 'World Explorer': [{ "question": "Which is the longest river in the world?", "options": ["Amazon", "Nile", "Yangtze", "Mississippi"], "correct_answer": "Nile", "fun_fact": "The Nile River flows through 11 countries in Africa." }, { "question": "What is the name of the tallest mountain in the world?", "options": ["K2", "Kangchenjunga", "Mount Everest", "Lhotse"], "correct_answer": "Mount Everest", "fun_fact": "Mount Everest is located in the Himalayas on the border of Nepal and China." }], 'Math & Logic': [{ "question": "How many sides does a triangle have?", "options": ["3", "4", "5", "6"], "correct_answer": "3", "fun_fact": "The sum of the angles in a triangle is always 180 degrees." }, { "question": "What is 15 + 25?", "options": ["30", "35", "40", "45"], "correct_answer": "40", "fun_fact": "Addition is one of the four basic operations of arithmetic." }], 'Aptitude Puzzles': [{ "question": "Which number comes next in the series: 2, 4, 6, 8, ...?", "options": ["9", "10", "12", "11"], "correct_answer": "10", "fun_fact": "This is a simple series of even numbers, increasing by 2 each time." }, { "question": "If a train travels 60 miles in 1 hour, how many miles does it travel in 30 minutes?", "options": ["15", "30", "45", "60"], "correct_answer": "30", "fun_fact": "30 minutes is half an hour, so the train would travel half the distance." }]};


// --- 4. CAMERA MODAL LOGIC (UPDATED FOR AI VISION) ---
const cameraModalOverlay = document.getElementById('camera-modal-overlay');
const closeCameraBtn = document.getElementById('close-camera-btn');
const videoFeed = document.getElementById('video-feed');
const mainCanvas = document.getElementById('main-canvas');
const takePhotoButton = document.getElementById('take-photo-button');
const saveButton = document.getElementById('save-button');
const retakeButton = document.getElementById('retake-button');
const saveModal = document.getElementById('save-modal');
const filenameInput = document.getElementById('filename-input');
const modalSaveBtn = document.getElementById('modal-save-btn');
const modalCancelBtn = document.getElementById('modal-cancel-btn');
const cameraView = document.getElementById('camera-view');
const editingView = document.getElementById('editing-view');
const flashOverlay = document.getElementById('flash-overlay');

// ‚ú® NEW: References for AI Vision UI
const describeButton = document.getElementById('describe-button');
const aiDescriptionContainer = document.getElementById('ai-description-container');
const aiDescriptionText = document.getElementById('ai-description-text');
const standardEditingControls = document.getElementById('standard-editing-controls');

let stream, currentFilter = "none",
    capturedImage, ctx = mainCanvas.getContext("2d");
let cameraIntent = 'save'; // ‚ú® NEW: To track camera's purpose ('save' or 'describe')

async function handlePhotoCapture(intent) {
    cameraIntent = intent;
    cameraModalOverlay.classList.remove("hidden");
    setTimeout(() => cameraModalOverlay.classList.add("visible"), 10);
    await startCamera();
}

async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: true
        });
        videoFeed.srcObject = stream;
        await videoFeed.play();
        cameraView.classList.remove("hidden");
        editingView.classList.add("hidden");
        editingView.classList.remove("flex");
        takePhotoButton.classList.remove("hidden");
    } catch (err) {
        console.error("Error accessing camera: ", err);
    }
}

function stopCamera() {
    if (stream) stream.getTracks().forEach(track => track.stop());
}

function capturePhoto() {
    mainCanvas.width = videoFeed.videoWidth;
    mainCanvas.height = videoFeed.videoHeight;
    ctx.drawImage(videoFeed, 0, 0, mainCanvas.width, mainCanvas.height);
    capturedImage = new Image();
    capturedImage.src = mainCanvas.toDataURL("image/jpeg");
    capturedImage.onload = () => {
        cameraView.classList.add("hidden");
        editingView.classList.remove("hidden");
        editingView.classList.add("flex");
        stopCamera();
        flashEffect();

        // ‚ú® NEW: Show correct buttons based on intent
        if (cameraIntent === 'describe') {
            saveButton.classList.add('hidden');
            describeButton.classList.remove('hidden');
            standardEditingControls.classList.add('hidden');
        } else {
            saveButton.classList.remove('hidden');
            describeButton.classList.add('hidden');
            standardEditingControls.classList.remove('hidden');
        }
    }
}

function flashEffect() {
    flashOverlay.style.width = `${mainCanvas.offsetWidth}px`;
    flashOverlay.style.height = `${mainCanvas.offsetHeight}px`;
    flashOverlay.classList.remove("hidden");
    flashOverlay.classList.add("flash");
    setTimeout(() => {
        flashOverlay.classList.add("hidden");
        flashOverlay.classList.remove("flash");
    }, 500);
}

function redrawCanvas() {
    ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
    ctx.filter = currentFilter;
    ctx.drawImage(capturedImage, 0, 0, mainCanvas.width, mainCanvas.height);
    ctx.filter = "none";
}

// ‚ú® NEW: Logic for AI Vision button
describeButton.addEventListener('click', async () => {
    describeButton.disabled = true;
    describeButton.textContent = "ü§î Thinking...";
    aiDescriptionContainer.classList.remove('hidden');
    aiDescriptionText.textContent = "Let me see... what do we have here?";

    const imageDataUrl = mainCanvas.toDataURL("image/jpeg", 0.9);

    try {
        const response = await fetch('/describe-object', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageDataUrl })
        });
        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

        const data = await response.json();
        aiDescriptionText.textContent = data.description;
        speakText(data.description, false); // Speak without captions

    } catch (error) {
        console.error("Error describing object:", error);
        const errorMsg = "Sorry, I had trouble understanding that. Could we try again?";
        aiDescriptionText.textContent = errorMsg;
        speakText(errorMsg, false);
    } finally {
        describeButton.disabled = false;
        describeButton.textContent = "üëÄ Describe with AI";
    }
});


// Existing camera event listeners
closeCameraBtn.addEventListener('click', () => {
    cameraModalOverlay.classList.remove("visible");
    setTimeout(() => cameraModalOverlay.classList.add("hidden"), 500);
    stopCamera();
});

takePhotoButton.addEventListener('click', capturePhoto);

retakeButton.addEventListener("click", () => {
    currentFilter = "none";
    aiDescriptionContainer.classList.add('hidden'); // Hide description on retake
    aiDescriptionText.textContent = '';
    startCamera();
});

saveButton.addEventListener('click', () => saveModal.classList.remove("hidden"));
modalCancelBtn.addEventListener('click', () => saveModal.classList.add("hidden"));
modalSaveBtn.addEventListener("click", () => {
    const filename = filenameInput.value.trim() || "avatar-photo";
    const imageDataUrl = mainCanvas.toDataURL("image/jpeg");
    triggerAutoDownload(imageDataUrl, filename);
    saveModal.classList.add("hidden");
    closeCameraBtn.click();
});

document.querySelectorAll(".filter-button").forEach(button => {
    button.addEventListener("click", () => {
        const filter = button.dataset.filter;
        switch (filter) {
            case "none": currentFilter = "none"; break;
            case "grayscale": currentFilter = "grayscale(1)"; break;
            case "sepia": currentFilter = "sepia(1)"; break;
            case "invert": currentFilter = "invert(1)"; break;
            case "saturate": currentFilter = "saturate(200%)"; break;
            case "contrast": currentFilter = "contrast(200%)"; break;
            case "brightness": currentFilter = "brightness(150%)"; break;
            case "blur": currentFilter = "blur(5px)"; break;
        }
        redrawCanvas();
    });
});

function triggerAutoDownload(dataUrl, filename) {
    const link = document.createElement("a");
    link.href = dataUrl;
    link.download = `${filename}.jpeg`;
    link.click();
}   